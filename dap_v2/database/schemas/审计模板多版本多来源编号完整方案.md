# 审计底稿与报告模板多版本多来源编号完整方案

## 一、需求分析

### 核心场景
1. **多事务所**: 不同会计师事务所有自己的底稿模板
2. **多版本**: 同一模板可能有多个版本(如年度更新、准则变更)
3. **多套系统**: 可能导入鼎信诺、中普、四大等不同来源模板
4. **底稿vs报告**: 审计底稿和审计报告需要明确区分
5. **实例vs模板**: 模板是蓝图,底稿实例是具体项目使用

### 编号层级
```
┌─────────────────────────────────────┐
│ 1. 模板来源 (Template Source)        │
│    - 事务所/软件厂商                  │
├─────────────────────────────────────┤
│ 2. 模板类型 (Template Type)          │
│    - 审计底稿 vs 审计报告             │
├─────────────────────────────────────┤
│ 3. 模板分类 (Template Category)      │
│    - 资产/负债/损益/合并等            │
├─────────────────────────────────────┤
│ 4. 模板版本 (Template Version)       │
│    - V1.0, V2.0, V2024...           │
├─────────────────────────────────────┤
│ 5. 底稿实例 (Workpaper Instance)     │
│    - 具体项目中使用的底稿             │
└─────────────────────────────────────┘
```

---

## 二、完整编号方案 (五级编码体系)

### 方案架构图
```
模板编号 (Template Code)
    ↓
[来源]-[类型]-[分类]-[序号]-V[版本]
    ↓
实例编号 (Instance Code)
    ↓
[项目]-[模板引用]-[实例序号]
```

---

## 三、详细编号规则

### 第一级: 模板来源标识 (Source Identifier)

#### 来源代码表
| 代码 | 来源 | 说明 |
|------|------|------|
| **SYS** | System | 系统内置标准模板 |
| **DXN** | 鼎信诺 | 鼎信诺审计软件模板 |
| **ZP** | 中普 | 中普审计软件模板 |
| **PWC** | 普华永道 | PwC底稿模板 |
| **DTT** | 德勤 | Deloitte底稿模板 |
| **EY** | 安永 | Ernst & Young底稿模板 |
| **KPMG** | 毕马威 | KPMG底稿模板 |
| **RSM** | 瑞华 | 瑞华会计师事务所 |
| **CST** | Custom | 用户自定义模板 |

### 第二级: 模板类型 (Template Type)

| 代码 | 类型 | 说明 |
|------|------|------|
| **WP** | Workpaper | 审计底稿模板 |
| **AR** | Audit Report | 审计报告模板 |
| **ML** | Management Letter | 管理建议书模板 |
| **TC** | Technical Committee | 技术委员会文档模板 |

### 第三级: 模板分类 (Category)

#### 审计底稿分类
| 代码 | 分类 | 说明 |
|------|------|------|
| **A** | Asset | 资产类 (货币资金、应收、存货、固定资产) |
| **B** | Special Asset | 特殊资产 (长投、无形资产、商誉) |
| **L** | Liability | 负债类 |
| **E** | Equity | 权益类 |
| **PL** | P&L | 损益类 |
| **CF** | Cash Flow | 现金流量 |
| **C** | Consolidation | 合并报表 |
| **M** | Memo | 备忘录 |
| **T** | Test | 测试类 |

#### 审计报告分类
| 代码 | 分类 | 说明 |
|------|------|------|
| **STD** | Standard | 标准无保留意见 |
| **MOD** | Modified | 保留/否定/无法表示 |
| **IPO** | IPO | IPO审计报告 |
| **TAX** | Tax | 税务审计报告 |
| **SPC** | Special | 专项审计报告 |

### 第四级: 序号 (Sequence Number)

- 每个分类下的流水号
- 格式: 两位数字 `01-99`

### 第五级: 版本号 (Version)

#### 版本命名规则
```
V{主版本}.{次版本}.{年度}

示例:
V1.0       - 第一版
V1.1       - 第一版的小修订
V2.0       - 第二版(大版本更新)
V2.0.2024  - 2024年度版本
V3.0.2025  - 2025年度新准则版本
```

---

## 四、完整编号示例

### 模板编号 (Template Code)

#### 审计底稿模板
```
格式: {来源}-{类型}-{分类}-{序号}-V{版本}

示例:
SYS-WP-A-01-V1.0          系统内置-审计底稿-资产类-01号-版本1.0
  └─ 货币资金审定表(标准版)

DXN-WP-A-01-V2.0.2024     鼎信诺-审计底稿-资产类-01号-2024版
  └─ 货币资金审定表(鼎信诺2024版)

ZP-WP-A-01-V1.5           中普-审计底稿-资产类-01号-版本1.5
  └─ 货币资金审定表(中普版)

PWC-WP-A-01-V3.0          普华永道-审计底稿-资产类-01号-版本3.0
  └─ 货币资金审定表(PWC版)

SYS-WP-C-01-V1.0          系统-审计底稿-合并类-01号-版本1.0
  └─ 合并报表抵消分录汇总表

CST-WP-M-01-V1.0          自定义-审计底稿-备忘录-01号-版本1.0
  └─ 某事务所自定义风险评估模板
```

#### 审计报告模板
```
格式: {来源}-{类型}-{分类}-{序号}-V{版本}

示例:
SYS-AR-STD-01-V1.0        系统-审计报告-标准-01号-版本1.0
  └─ 标准无保留意见审计报告

DXN-AR-IPO-01-V2.0.2024   鼎信诺-审计报告-IPO-01号-2024版
  └─ IPO审计报告(鼎信诺2024版)

ZP-AR-TAX-01-V1.0         中普-审计报告-税审-01号-版本1.0
  └─ 税务审计报告(中普版)

SYS-ML-STD-01-V1.0        系统-管理建议书-标准-01号-版本1.0
  └─ 标准管理建议书模板
```

### 底稿实例编号 (Workpaper Instance Code)

#### 格式
```
{项目编号}-{模板引用}-{实例序号}

其中:
- 项目编号: 项目的唯一标识
- 模板引用: 使用的模板编号(简化)
- 实例序号: 在该项目中的序号
```

#### 示例
```
项目: 2024年XX公司年度审计

IPO-2024-001-WP-A-01          项目IPO-2024-001的资产类底稿01
  └─ 使用模板: SYS-WP-A-01-V1.0

IPO-2024-001-WP-A-01-01       子底稿01
IPO-2024-001-WP-A-01-02       子底稿02

IPO-2024-001-WP-C-01          项目IPO-2024-001的合并类底稿01
  └─ 使用模板: DXN-WP-C-01-V2.0.2024

IPO-2024-001-AR-STD-001       项目的标准审计报告
  └─ 使用模板: SYS-AR-STD-01-V1.0
```

---

## 五、数据库设计方案

### 1. 模板来源表 (template_sources)
```sql
CREATE TABLE template_sources (
    id UUID PRIMARY KEY,
    source_code VARCHAR(10) UNIQUE NOT NULL,    -- SYS/DXN/ZP/PWC...
    source_name VARCHAR(100) NOT NULL,          -- 鼎信诺/中普/普华永道
    source_type VARCHAR(20),                    -- SYSTEM/VENDOR/FIRM/CUSTOM
    vendor_version VARCHAR(50),                 -- 软件版本号(如适用)
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 插入默认数据
INSERT INTO template_sources (source_code, source_name, source_type, description) VALUES
('SYS', '系统内置', 'SYSTEM', 'DAP系统标准模板'),
('DXN', '鼎信诺', 'VENDOR', '鼎信诺审计软件模板'),
('ZP', '中普', 'VENDOR', '中普审计软件模板'),
('PWC', '普华永道', 'FIRM', 'PwC底稿模板'),
('DTT', '德勤', 'FIRM', 'Deloitte底稿模板'),
('EY', '安永', 'FIRM', 'EY底稿模板'),
('KPMG', '毕马威', 'FIRM', 'KPMG底稿模板'),
('RSM', '瑞华', 'FIRM', '瑞华会计师事务所模板'),
('CST', '自定义', 'CUSTOM', '用户自定义模板');
```

### 2. 增强的workpaper_templates表
```sql
ALTER TABLE workpaper_templates ADD COLUMN IF NOT EXISTS
    source_id UUID REFERENCES template_sources(id),          -- 模板来源
    template_type VARCHAR(10) NOT NULL DEFAULT 'WP',         -- WP/AR/ML/TC
    template_category VARCHAR(10),                           -- A/B/L/E/PL/CF/C/M/T...
    category_name VARCHAR(50),                               -- 分类中文名
    template_sequence INTEGER,                               -- 序号
    version_major INTEGER DEFAULT 1,                         -- 主版本号
    version_minor INTEGER DEFAULT 0,                         -- 次版本号
    version_year INTEGER,                                    -- 年度版本
    version_string VARCHAR(20),                              -- 完整版本字符串 V1.0.2024
    full_template_code VARCHAR(50) UNIQUE,                   -- 完整模板编号
    parent_template_id UUID REFERENCES workpaper_templates(id), -- 父模板(用于版本继承)
    is_latest_version BOOLEAN DEFAULT TRUE,                  -- 是否最新版本
    replaced_by UUID REFERENCES workpaper_templates(id),     -- 被哪个版本替代
    effective_date DATE,                                     -- 生效日期
    expiry_date DATE,                                        -- 失效日期
    change_log TEXT;                                         -- 版本变更日志
```

### 3. 模板编号自动生成函数
```python
def generate_template_code(
    source_code: str,      # SYS/DXN/ZP...
    template_type: str,    # WP/AR/ML/TC
    category: str,         # A/B/L/PL/STD/IPO...
    sequence: int,         # 序号
    version_major: int,    # 主版本
    version_minor: int,    # 次版本
    version_year: int = None  # 年度(可选)
) -> str:
    """
    生成完整模板编号

    Returns:
        str: 如 SYS-WP-A-01-V1.0 或 DXN-AR-IPO-01-V2.0.2024
    """
    # 版本字符串
    if version_year:
        version_str = f"V{version_major}.{version_minor}.{version_year}"
    else:
        version_str = f"V{version_major}.{version_minor}"

    # 完整编号
    return f"{source_code}-{template_type}-{category}-{sequence:02d}-{version_str}"

# 示例
>>> generate_template_code("SYS", "WP", "A", 1, 1, 0)
'SYS-WP-A-01-V1.0'

>>> generate_template_code("DXN", "AR", "IPO", 1, 2, 0, 2024)
'DXN-AR-IPO-01-V2.0.2024'
```

### 4. 底稿实例编号生成
```python
def generate_workpaper_instance_code(
    project_code: str,     # 项目编号
    template_type: str,    # WP/AR
    category: str,         # A/B/L/PL...
    sequence: int,         # 实例序号
    parent_code: str = None  # 父底稿编号(用于子底稿)
) -> str:
    """
    生成底稿实例编号

    Returns:
        str: 如 IPO-2024-001-WP-A-01
    """
    if parent_code:
        # 子底稿: 父编号-子序号
        return f"{parent_code}-{sequence:02d}"
    else:
        # 主底稿
        return f"{project_code}-{template_type}-{category}-{sequence:02d}"

# 示例
>>> generate_workpaper_instance_code("IPO-2024-001", "WP", "A", 1)
'IPO-2024-001-WP-A-01'

>>> generate_workpaper_instance_code("IPO-2024-001", "WP", "A", 1, "IPO-2024-001-WP-A-01")
'IPO-2024-001-WP-A-01-01'
```

---

## 六、模板版本管理

### 版本继承树
```
SYS-WP-A-01-V1.0 (2020年)
    │
    ├─> SYS-WP-A-01-V1.1 (小修订)
    │
    └─> SYS-WP-A-01-V2.0 (2023年,新准则)
            │
            └─> SYS-WP-A-01-V2.0.2024 (2024年度版)
                    │
                    └─> SYS-WP-A-01-V3.0.2025 (2025年,最新准则)
```

### 版本升级规则
1. **主版本升级**: 重大变更、新准则、结构性改变
2. **次版本升级**: 功能增强、格式优化、字段调整
3. **年度版本**: 年度更新、案例更新、示例更新

### 版本切换策略
```sql
-- 查询某个模板的所有版本
SELECT
    full_template_code,
    version_string,
    is_latest_version,
    effective_date,
    expiry_date
FROM workpaper_templates
WHERE template_type = 'WP'
  AND template_category = 'A'
  AND template_sequence = 1
ORDER BY version_major DESC, version_minor DESC, version_year DESC;

-- 结果示例:
-- SYS-WP-A-01-V3.0.2025   V3.0.2025   TRUE   2025-01-01   NULL
-- SYS-WP-A-01-V2.0.2024   V2.0.2024   FALSE  2024-01-01   2024-12-31
-- SYS-WP-A-01-V1.0        V1.0        FALSE  2020-01-01   2023-12-31
```

---

## 七、用户界面展示

### 1. 模板库界面
```
┌─────────────────────────────────────────────────────────────────┐
│ 审计底稿模板库                                 [导入模板] [新建模板] │
├─────────────────────────────────────────────────────────────────┤
│ 来源筛选: [全部 ▼] [系统内置] [鼎信诺] [中普] [四大] [自定义]    │
│ 类型筛选: [全部 ▼] [审计底稿] [审计报告] [管理建议书]           │
│ 分类筛选: [全部 ▼] [资产类] [负债类] [损益类] [合并类]          │
├─────────────────────────────────────────────────────────────────┤
│ 模板编号              模板名称         来源    版本    状态        │
├─────────────────────────────────────────────────────────────────┤
│ SYS-WP-A-01-V1.0     货币资金审定表   系统   V1.0   [已使用]      │
│ DXN-WP-A-01-V2.0.2024 货币资金审定表  鼎信诺 V2.0.2024 [最新]   │
│ ZP-WP-A-01-V1.5      货币资金审定表   中普   V1.5   [可用]       │
│ PWC-WP-A-01-V3.0     Cash Lead Sheet  PWC    V3.0   [可用]      │
│                                                                   │
│ SYS-AR-STD-01-V1.0   标准审计报告     系统   V1.0   [最新]       │
│ DXN-AR-IPO-01-V2.0.2024 IPO审计报告  鼎信诺 V2.0.2024 [可用]   │
└─────────────────────────────────────────────────────────────────┘
```

### 2. 项目底稿列表
```
┌─────────────────────────────────────────────────────────────────┐
│ XX公司2024年度审计项目 - 审计底稿                               │
├─────────────────────────────────────────────────────────────────┤
│ 索引号                     底稿名称           使用模板           │
├─────────────────────────────────────────────────────────────────┤
│ IPO-2024-001-WP-A-01      货币资金审定表     SYS-WP-A-01-V1.0  │
│   IPO-2024-001-WP-A-01-01 库存现金盘点表     (继承)            │
│   IPO-2024-001-WP-A-01-02 银行存款函证       (继承)            │
│                                                                  │
│ IPO-2024-001-WP-C-01      合并报表抵消      DXN-WP-C-01-V2.0.2024│
│   IPO-2024-001-WP-C-01-01 长投抵消分录      (继承)             │
│   IPO-2024-001-WP-C-01-02 内部交易抵消      (继承)             │
│                                                                  │
│ IPO-2024-001-AR-STD-001   审计报告          SYS-AR-STD-01-V1.0 │
└─────────────────────────────────────────────────────────────────┘
```

### 3. 版本对比界面
```
┌─────────────────────────────────────────────────────────────────┐
│ 模板版本对比 - 货币资金审定表                                   │
├─────────────────────────────────────────────────────────────────┤
│ 版本1: SYS-WP-A-01-V1.0        版本2: DXN-WP-A-01-V2.0.2024   │
├─────────────────────────────────────────────────────────────────┤
│ [字段对比] [格式对比] [公式对比]                                │
│                                                                  │
│ 差异点:                                                          │
│ 1. 新增字段: "数字货币余额"                                     │
│ 2. 修改公式: 银行存款合计公式                                   │
│ 3. 格式调整: 增加函证回函率计算                                 │
│                                                 [选择使用版本2]  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 八、实施方案

### 第一阶段: 数据库结构调整
1. ✅ 创建template_sources表
2. ✅ 扩展workpaper_templates表字段
3. ✅ 添加版本管理相关字段
4. ✅ 创建索引和外键约束

### 第二阶段: 编号生成函数
1. ✅ 实现模板编号生成函数
2. ✅ 实现实例编号生成函数
3. ✅ 添加编号唯一性校验
4. ✅ 实现编号解析函数

### 第三阶段: 模板导入功能
1. ✅ 支持从鼎信诺导入模板
2. ✅ 支持从中普导入模板
3. ✅ 支持Excel模板导入
4. ✅ 自动分配编号

### 第四阶段: 版本管理
1. ✅ 版本升级功能
2. ✅ 版本对比功能
3. ✅ 版本切换功能
4. ✅ 版本继承关系维护

---

## 九、方案优势

### ✅ 解决的核心问题
1. **多来源支持**: 支持任意来源的模板导入
2. **版本管理**: 完整的版本控制和追溯
3. **清晰区分**: 模板vs实例、底稿vs报告
4. **灵活扩展**: 支持自定义和未来扩展
5. **兼容性好**: 兼容现有审计软件

### ✅ 编号特点
- **自描述性**: 从编号即可看出来源、类型、版本
- **唯一性**: 全局唯一,无冲突
- **可读性**: 符合审计人员习惯
- **可检索**: 支持按任意维度检索

---

## 十、完整示例数据

```sql
-- 模板来源
INSERT INTO template_sources VALUES
('SYS', '系统内置', 'SYSTEM'),
('DXN', '鼎信诺', 'VENDOR'),
('ZP', '中普', 'VENDOR'),
('PWC', '普华永道', 'FIRM');

-- 模板数据
INSERT INTO workpaper_templates VALUES
-- 系统内置货币资金模板
('uuid-001', 'SYS', 'WP', 'A', '资产类', 1, 1, 0, NULL, 'V1.0',
 'SYS-WP-A-01-V1.0', '货币资金审定表', TRUE, '2020-01-01', NULL),

-- 鼎信诺2024版货币资金模板
('uuid-002', 'DXN', 'WP', 'A', '资产类', 1, 2, 0, 2024, 'V2.0.2024',
 'DXN-WP-A-01-V2.0.2024', '货币资金审定表(鼎信诺2024版)', TRUE, '2024-01-01', NULL),

-- 系统内置标准审计报告模板
('uuid-003', 'SYS', 'AR', 'STD', '标准报告', 1, 1, 0, NULL, 'V1.0',
 'SYS-AR-STD-01-V1.0', '标准无保留意见审计报告', TRUE, '2020-01-01', NULL),

-- 鼎信诺IPO审计报告模板
('uuid-004', 'DXN', 'AR', 'IPO', 'IPO报告', 1, 2, 0, 2024, 'V2.0.2024',
 'DXN-AR-IPO-01-V2.0.2024', 'IPO审计报告(鼎信诺2024版)', TRUE, '2024-01-01', NULL);
```

---

请您review这个全新的完整方案!

**核心改进:**
1. ✅ 五级编码: 来源-类型-分类-序号-版本
2. ✅ 完整版本管理: 主版本.次版本.年度
3. ✅ 多来源支持: 系统/鼎信诺/中普/四大/自定义
4. ✅ 模板vs实例: 清晰区分蓝图和具体使用
5. ✅ 版本继承: 支持版本升级和替代关系

认可后立即实施到数据库和代码中!
