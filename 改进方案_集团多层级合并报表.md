# DAPç³»ç»Ÿæ”¹è¿›æ–¹æ¡ˆ - é›†å›¢å¤šå±‚çº§åˆå¹¶æŠ¥è¡¨åŠŸèƒ½

## ğŸ“‹ éœ€æ±‚åˆ†æ

### ç”¨æˆ·æå‡ºçš„3ä¸ªæ ¸å¿ƒéœ€æ±‚

**1. é¡¹ç›®ç®¡ç†å¢å¼º - å¤šå…¬å¸å±‚çº§ç»“æ„**
- åŒä¸€é¡¹ç›®ä¸‹æ”¯æŒå¤šä¸ªå…¬å¸(æ¯å­å…¬å¸/æŠ•èµ„å…¬å¸/æ§è‚¡å…¬å¸)
- æ”¯æŒå¤šå±‚çº§ç»“æ„(è‡³å°‘6å±‚)
- ä¸ºæœªæ¥åˆå¹¶æŠ¥è¡¨åŠŸèƒ½åšæ•°æ®åŸºç¡€å‡†å¤‡

**2. åˆå¹¶æŠ¥è¡¨åŠŸèƒ½**
- å®ç°é›†å›¢å±‚é¢çš„åˆå¹¶è´¢åŠ¡æŠ¥è¡¨
- æ”¯æŒæ¯å­å…¬å¸æ•°æ®è‡ªåŠ¨æŠµé”€
- è·¨å±‚çº§æ•°æ®èšåˆå’Œåˆå¹¶

**3. äººæœºäº¤äº’ - è‡ªç„¶è¯­è¨€æŸ¥è¯¢**
- æ”¯æŒä»»æ„æ ¼å¼çš„è‡ªç„¶è¯­è¨€æŸ¥è¯¢
- æ¶µç›–å‡­è¯ã€ç§‘ç›®ã€æ•°æ®ç­‰æ‰€æœ‰æŸ¥è¯¢éœ€æ±‚
- æ— ç‰¹å®šæ ¼å¼è¦æ±‚,æ™ºèƒ½ç†è§£ç”¨æˆ·æ„å›¾

---

## ğŸ¯ æ€»ä½“è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ç”¨æˆ·ç•Œé¢å±‚ (GUIæ”¹è¿›)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ é¡¹ç›®ç®¡ç†ç•Œé¢  â”‚ å…¬å¸å±‚çº§ç®¡ç†  â”‚ åˆå¹¶æŠ¥è¡¨ç•Œé¢ â”‚         â”‚
â”‚  â”‚  - é¡¹ç›®åˆ—è¡¨   â”‚  - æ ‘å½¢ç»“æ„   â”‚  - æŠ¥è¡¨é€‰æ‹©  â”‚         â”‚
â”‚  â”‚  - åˆ›å»º/ç¼–è¾‘  â”‚  - æ‹–æ‹½è°ƒæ•´   â”‚  - å‚æ•°è®¾ç½®  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚         è‡ªç„¶è¯­è¨€æŸ¥è¯¢ç•Œé¢                     â”‚         â”‚
â”‚  â”‚  - è¾“å…¥æ¡† + æ™ºèƒ½æç¤º                        â”‚         â”‚
â”‚  â”‚  - å†å²è®°å½• + å¿«æ·æŸ¥è¯¢                       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ä¸šåŠ¡é€»è¾‘å±‚ (æ–°å¢åŠŸèƒ½æ¨¡å—)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚é›†å›¢å±‚çº§ç®¡ç†å™¨ â”‚ åˆå¹¶æŠ¥è¡¨å¼•æ“  â”‚ NLæŸ¥è¯¢å¼•æ“   â”‚         â”‚
â”‚  â”‚- å±‚çº§CRUD    â”‚ - æ•°æ®åˆå¹¶    â”‚ - æ„å›¾è¯†åˆ«   â”‚         â”‚
â”‚  â”‚- æŒè‚¡è®¡ç®—    â”‚ - æŠµé”€å¤„ç†    â”‚ - SQLç”Ÿæˆ    â”‚         â”‚
â”‚  â”‚- å…³ç³»ç»´æŠ¤    â”‚ - å°‘æ•°æƒç›Š    â”‚ - ç»“æœæ ¼å¼åŒ–  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®å±‚ (æ•°æ®åº“Schemaæ‰©å±•)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ projects (é¡¹ç›®è¡¨)                        â”‚           â”‚
â”‚  â”‚  - project_id, project_name, ...        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ entities (å…¬å¸å®ä½“è¡¨) - æ–°å¢               â”‚           â”‚
â”‚  â”‚  - entity_id, entity_name, entity_code   â”‚           â”‚
â”‚  â”‚  - parent_entity_id, level, hierarchy     â”‚           â”‚
â”‚  â”‚  - project_id (å¤–é”®)                      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ entity_relationships (å±‚çº§å…³ç³»è¡¨) - æ–°å¢   â”‚           â”‚
â”‚  â”‚  - parent_id, child_id, relationship_type â”‚           â”‚
â”‚  â”‚  - ownership_percentage, control_type     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ consolidation_adjustments (æŠµé”€åˆ†å½•) - æ–°å¢â”‚           â”‚
â”‚  â”‚  - adjustment_id, period, entity_pair     â”‚           â”‚
â”‚  â”‚  - adjustment_type, amount, description   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ fact_vouchers/fact_entries (å‡­è¯/åˆ†å½•)    â”‚           â”‚
â”‚  â”‚  - å¢åŠ  entity_id å­—æ®µå…³è”                â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š è¯¦ç»†è®¾è®¡æ–¹æ¡ˆ

### ä¸€ã€æ•°æ®åº“Schemaè®¾è®¡

#### 1.1 æ–°å¢è¡¨ç»“æ„

```sql
-- 1. å…¬å¸å®ä½“è¡¨ (entities)
CREATE TABLE IF NOT EXISTS entities (
    entity_id INTEGER PRIMARY KEY AUTOINCREMENT,
    entity_code TEXT NOT NULL UNIQUE,           -- å…¬å¸ç¼–ç 
    entity_name TEXT NOT NULL,                  -- å…¬å¸åç§°
    entity_type TEXT,                           -- å…¬å¸ç±»å‹: æ¯å…¬å¸/å­å…¬å¸/å­™å…¬å¸
    project_id TEXT NOT NULL,                   -- æ‰€å±é¡¹ç›®ID
    parent_entity_id INTEGER,                   -- çˆ¶å…¬å¸ID (è‡ªå…³è”)
    level INTEGER DEFAULT 1,                    -- å±‚çº§: 1=æ¯å…¬å¸, 2=å­å…¬å¸, ...
    hierarchy_path TEXT,                        -- å±‚çº§è·¯å¾„: 1.2.3
    ownership_percentage REAL DEFAULT 100.0,    -- æŒè‚¡æ¯”ä¾‹
    control_type TEXT,                          -- æ§åˆ¶ç±»å‹: å…¨èµ„/æ§è‚¡/å‚è‚¡
    industry TEXT,                              -- æ‰€å±è¡Œä¸š
    registration_no TEXT,                       -- æ³¨å†Œå·/ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç 
    legal_representative TEXT,                  -- æ³•å®šä»£è¡¨äºº
    establish_date DATE,                        -- æˆç«‹æ—¥æœŸ
    registered_capital REAL,                    -- æ³¨å†Œèµ„æœ¬
    address TEXT,                               -- æ³¨å†Œåœ°å€
    business_scope TEXT,                        -- ç»è¥èŒƒå›´
    status TEXT DEFAULT 'active',               -- çŠ¶æ€: active/inactive
    fiscal_year_end TEXT,                       -- ä¼šè®¡å¹´åº¦ç»“æŸæœˆæ—¥: 12-31
    currency TEXT DEFAULT 'CNY',                -- è®°è´¦æœ¬ä½å¸
    tax_number TEXT,                            -- çº³ç¨äººè¯†åˆ«å·
    is_consolidated BOOLEAN DEFAULT 1,          -- æ˜¯å¦çº³å…¥åˆå¹¶èŒƒå›´
    notes TEXT,                                 -- å¤‡æ³¨
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by TEXT,

    FOREIGN KEY (project_id) REFERENCES projects(project_id),
    FOREIGN KEY (parent_entity_id) REFERENCES entities(entity_id)
);

-- ç´¢å¼•
CREATE INDEX idx_entities_project ON entities(project_id);
CREATE INDEX idx_entities_parent ON entities(parent_entity_id);
CREATE INDEX idx_entities_level ON entities(level);
CREATE INDEX idx_entities_code ON entities(entity_code);

-- 2. å®ä½“å…³ç³»è¡¨ (entity_relationships)
CREATE TABLE IF NOT EXISTS entity_relationships (
    relationship_id INTEGER PRIMARY KEY AUTOINCREMENT,
    parent_entity_id INTEGER NOT NULL,          -- æ¯å…¬å¸ID
    child_entity_id INTEGER NOT NULL,           -- å­å…¬å¸ID
    relationship_type TEXT NOT NULL,            -- å…³ç³»ç±»å‹: å­å…¬å¸/è”è¥/åˆè¥
    ownership_percentage REAL NOT NULL,         -- æŒè‚¡æ¯”ä¾‹
    voting_rights_percentage REAL,              -- è¡¨å†³æƒæ¯”ä¾‹
    control_type TEXT,                          -- æ§åˆ¶ç±»å‹: æ§åˆ¶/å…±åŒæ§åˆ¶/é‡å¤§å½±å“
    acquisition_date DATE,                      -- å–å¾—æ—¥æœŸ
    acquisition_cost REAL,                      -- æŠ•èµ„æˆæœ¬
    fair_value_at_acquisition REAL,             -- è´­ä¹°æ—¥å…¬å…ä»·å€¼
    goodwill REAL,                              -- å•†èª‰
    investment_account TEXT,                    -- æŠ•èµ„ç§‘ç›®ç¼–ç 
    equity_method BOOLEAN DEFAULT 0,            -- æ˜¯å¦æƒç›Šæ³•æ ¸ç®—
    consolidation_method TEXT,                  -- åˆå¹¶æ–¹æ³•: å…¨é¢/æ¯”ä¾‹/æƒç›Š
    effective_date DATE,                        -- ç”Ÿæ•ˆæ—¥æœŸ
    expiry_date DATE,                           -- å¤±æ•ˆæ—¥æœŸ
    is_active BOOLEAN DEFAULT 1,                -- æ˜¯å¦æœ‰æ•ˆ
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (parent_entity_id) REFERENCES entities(entity_id),
    FOREIGN KEY (child_entity_id) REFERENCES entities(entity_id),
    UNIQUE(parent_entity_id, child_entity_id, effective_date)
);

CREATE INDEX idx_relationships_parent ON entity_relationships(parent_entity_id);
CREATE INDEX idx_relationships_child ON entity_relationships(child_entity_id);

-- 3. å†…éƒ¨äº¤æ˜“è¡¨ (intercompany_transactions)
CREATE TABLE IF NOT EXISTS intercompany_transactions (
    transaction_id INTEGER PRIMARY KEY AUTOINCREMENT,
    transaction_date DATE NOT NULL,             -- äº¤æ˜“æ—¥æœŸ
    seller_entity_id INTEGER NOT NULL,          -- é”€å”®æ–¹å…¬å¸ID
    buyer_entity_id INTEGER NOT NULL,           -- è´­ä¹°æ–¹å…¬å¸ID
    transaction_type TEXT NOT NULL,             -- äº¤æ˜“ç±»å‹: é”€å”®/é‡‡è´­/æœåŠ¡/ç§Ÿèµ/å€Ÿæ¬¾/æ‹…ä¿
    subject_matter TEXT,                        -- äº¤æ˜“æ ‡çš„
    amount REAL NOT NULL,                       -- äº¤æ˜“é‡‘é¢
    currency TEXT DEFAULT 'CNY',
    seller_voucher_id INTEGER,                  -- é”€å”®æ–¹å‡­è¯ID
    buyer_voucher_id INTEGER,                   -- è´­ä¹°æ–¹å‡­è¯ID
    seller_account TEXT,                        -- é”€å”®æ–¹ç§‘ç›®
    buyer_account TEXT,                         -- è´­ä¹°æ–¹ç§‘ç›®
    unrealized_profit REAL DEFAULT 0,           -- æœªå®ç°å†…éƒ¨åˆ©æ¶¦
    elimination_needed BOOLEAN DEFAULT 1,       -- æ˜¯å¦éœ€è¦æŠµé”€
    fiscal_period TEXT,                         -- ä¼šè®¡æœŸé—´
    description TEXT,                           -- äº¤æ˜“æè¿°
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (seller_entity_id) REFERENCES entities(entity_id),
    FOREIGN KEY (buyer_entity_id) REFERENCES entities(entity_id),
    FOREIGN KEY (seller_voucher_id) REFERENCES fact_vouchers(voucher_id),
    FOREIGN KEY (buyer_voucher_id) REFERENCES fact_vouchers(voucher_id)
);

CREATE INDEX idx_ic_trans_date ON intercompany_transactions(transaction_date);
CREATE INDEX idx_ic_trans_seller ON intercompany_transactions(seller_entity_id);
CREATE INDEX idx_ic_trans_buyer ON intercompany_transactions(buyer_entity_id);
CREATE INDEX idx_ic_trans_period ON intercompany_transactions(fiscal_period);

-- 4. åˆå¹¶æŠµé”€åˆ†å½•è¡¨ (consolidation_adjustments)
CREATE TABLE IF NOT EXISTS consolidation_adjustments (
    adjustment_id INTEGER PRIMARY KEY AUTOINCREMENT,
    consolidation_period TEXT NOT NULL,         -- åˆå¹¶æœŸé—´
    adjustment_type TEXT NOT NULL,              -- æŠµé”€ç±»å‹: å†…éƒ¨äº¤æ˜“/å†…éƒ¨å€ºæƒå€ºåŠ¡/æœªå®ç°åˆ©æ¶¦/æŠ•èµ„æ”¶ç›Š
    adjustment_category TEXT,                   -- æŠµé”€åˆ†ç±»: åŒçº§/ä¸Šä¸‹çº§
    entity_pair TEXT,                           -- æ¶‰åŠå®ä½“å¯¹: entity1_id,entity2_id
    reference_transaction_id INTEGER,           -- å…³è”å†…éƒ¨äº¤æ˜“ID
    debit_account TEXT NOT NULL,                -- å€Ÿæ–¹ç§‘ç›®
    credit_account TEXT NOT NULL,               -- è´·æ–¹ç§‘ç›®
    amount REAL NOT NULL,                       -- æŠµé”€é‡‘é¢
    description TEXT,                           -- æŠµé”€è¯´æ˜
    auto_generated BOOLEAN DEFAULT 0,           -- æ˜¯å¦è‡ªåŠ¨ç”Ÿæˆ
    is_manual BOOLEAN DEFAULT 0,                -- æ˜¯å¦æ‰‹å·¥è°ƒæ•´
    approved BOOLEAN DEFAULT 0,                 -- æ˜¯å¦å®¡æ ¸
    approved_by TEXT,
    approved_at TIMESTAMP,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by TEXT,

    FOREIGN KEY (reference_transaction_id) REFERENCES intercompany_transactions(transaction_id)
);

CREATE INDEX idx_consol_adj_period ON consolidation_adjustments(consolidation_period);
CREATE INDEX idx_consol_adj_type ON consolidation_adjustments(adjustment_type);

-- 5. åˆå¹¶æŠ¥è¡¨å…ƒæ•°æ®è¡¨ (consolidation_metadata)
CREATE TABLE IF NOT EXISTS consolidation_metadata (
    consolidation_id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id TEXT NOT NULL,                   -- é¡¹ç›®ID
    consolidation_period TEXT NOT NULL,         -- åˆå¹¶æœŸé—´
    parent_entity_id INTEGER NOT NULL,          -- æ¯å…¬å¸ID
    consolidation_scope TEXT,                   -- åˆå¹¶èŒƒå›´: JSON array of entity_ids
    consolidation_method TEXT DEFAULT 'full',   -- åˆå¹¶æ–¹æ³•: full/proportional
    exchange_rate_date DATE,                    -- æ±‡ç‡æ—¥æœŸ
    exchange_rates TEXT,                        -- æ±‡ç‡è¡¨: JSON
    minority_interest_method TEXT DEFAULT 'fair_value', -- å°‘æ•°è‚¡ä¸œæƒç›Šè®¡é‡: fair_value/proportional
    goodwill_impairment REAL DEFAULT 0,         -- å•†èª‰å‡å€¼
    adjustment_count INTEGER DEFAULT 0,          -- æŠµé”€åˆ†å½•æ•°é‡
    status TEXT DEFAULT 'draft',                -- çŠ¶æ€: draft/in_progress/completed/approved
    report_generated BOOLEAN DEFAULT 0,          -- æ˜¯å¦å·²ç”ŸæˆæŠ¥è¡¨
    report_path TEXT,                           -- æŠ¥è¡¨æ–‡ä»¶è·¯å¾„
    generated_at TIMESTAMP,
    generated_by TEXT,
    approved_at TIMESTAMP,
    approved_by TEXT,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (project_id) REFERENCES projects(project_id),
    FOREIGN KEY (parent_entity_id) REFERENCES entities(entity_id),
    UNIQUE(project_id, consolidation_period, parent_entity_id)
);

CREATE INDEX idx_consol_meta_project ON consolidation_metadata(project_id);
CREATE INDEX idx_consol_meta_period ON consolidation_metadata(consolidation_period);
```

#### 1.2 ç°æœ‰è¡¨ä¿®æ”¹

```sql
-- ä¿®æ”¹ fact_vouchers è¡¨,å¢åŠ  entity_id
ALTER TABLE fact_vouchers ADD COLUMN entity_id INTEGER;
CREATE INDEX idx_vouchers_entity ON fact_vouchers(entity_id);

-- ä¿®æ”¹ fact_entries è¡¨,å¢åŠ  entity_id
ALTER TABLE fact_entries ADD COLUMN entity_id INTEGER;
CREATE INDEX idx_entries_entity ON fact_entries(entity_id);

-- ä¿®æ”¹ dim_accounts è¡¨,å¢åŠ è´¦å¥—æ”¯æŒ
ALTER TABLE dim_accounts ADD COLUMN entity_id INTEGER;
CREATE INDEX idx_accounts_entity ON dim_accounts(entity_id);
```

---

### äºŒã€GUIç•Œé¢è®¾è®¡

#### 2.1 é¡¹ç›®ç®¡ç†ç•Œé¢å‡çº§

**ç°æœ‰ç•Œé¢æ”¹è¿›:**

```python
# dap_launcher.py ä¸­çš„é¡¹ç›®è®¾ç½®åŒºåŸŸå‡çº§

def create_project_management_tab(self, parent):
    """åˆ›å»ºé¡¹ç›®ç®¡ç†æ ‡ç­¾é¡µ - å…¨æ–°è®¾è®¡"""
    project_frame = ttk.Frame(parent, padding="10")
    parent.add(project_frame, text="é¡¹ç›®ç®¡ç†")

    # å·¦ä¾§: é¡¹ç›®åˆ—è¡¨
    left_pane = ttk.Frame(project_frame)
    left_pane.grid(row=0, column=0, sticky="nsew", padx=(0,5))

    # é¡¹ç›®åˆ—è¡¨æ ‘å½¢æ§ä»¶
    project_tree_frame = ttk.LabelFrame(left_pane, text="é¡¹ç›®åˆ—è¡¨", padding="5")
    project_tree_frame.pack(fill="both", expand=True)

    self.project_tree = ttk.Treeview(
        project_tree_frame,
        columns=("é¡¹ç›®ç¼–ç ", "å®¢æˆ·", "å¹´åº¦", "çŠ¶æ€"),
        show="tree headings"
    )
    self.project_tree.heading("#0", text="é¡¹ç›®åç§°")
    self.project_tree.heading("é¡¹ç›®ç¼–ç ", text="ç¼–ç ")
    self.project_tree.heading("å®¢æˆ·", text="å®¢æˆ·")
    self.project_tree.heading("å¹´åº¦", text="å¹´åº¦")
    self.project_tree.heading("çŠ¶æ€", text="çŠ¶æ€")

    self.project_tree.pack(fill="both", expand=True)

    # é¡¹ç›®æ“ä½œæŒ‰é’®
    btn_frame = ttk.Frame(left_pane)
    btn_frame.pack(fill="x", pady=5)

    ttk.Button(btn_frame, text="â• æ–°å»ºé¡¹ç›®",
              command=self.create_new_project).pack(side="left", padx=2)
    ttk.Button(btn_frame, text="âœï¸ ç¼–è¾‘",
              command=self.edit_project).pack(side="left", padx=2)
    ttk.Button(btn_frame, text="ğŸ—‘ï¸ åˆ é™¤",
              command=self.delete_project).pack(side="left", padx=2)
    ttk.Button(btn_frame, text="ğŸ”„ åˆ·æ–°",
              command=self.refresh_projects).pack(side="left", padx=2)

    # å³ä¾§: å…¬å¸å±‚çº§ç®¡ç†
    right_pane = ttk.Frame(project_frame)
    right_pane.grid(row=0, column=1, sticky="nsew", padx=(5,0))

    # å…¬å¸å±‚çº§æ ‘å½¢ç»“æ„
    entity_frame = ttk.LabelFrame(right_pane, text="å…¬å¸ç»„ç»‡ç»“æ„", padding="5")
    entity_frame.pack(fill="both", expand=True)

    # å·¥å…·æ 
    toolbar = ttk.Frame(entity_frame)
    toolbar.pack(fill="x", pady=(0,5))

    ttk.Button(toolbar, text="â• æ·»åŠ å…¬å¸",
              command=self.add_entity).pack(side="left", padx=2)
    ttk.Button(toolbar, text="â• æ·»åŠ å­å…¬å¸",
              command=self.add_sub_entity).pack(side="left", padx=2)
    ttk.Button(toolbar, text="âœï¸ ç¼–è¾‘å…³ç³»",
              command=self.edit_relationship).pack(side="left", padx=2)
    ttk.Button(toolbar, text="ğŸ“Š æŸ¥çœ‹å±‚çº§å›¾",
              command=self.view_hierarchy_chart).pack(side="left", padx=2)

    # æ ‘å½¢æ§ä»¶
    self.entity_tree = ttk.Treeview(
        entity_frame,
        columns=("ç¼–ç ", "ç±»å‹", "æŒè‚¡æ¯”ä¾‹", "å±‚çº§"),
        show="tree headings"
    )
    self.entity_tree.heading("#0", text="å…¬å¸åç§°")
    self.entity_tree.heading("ç¼–ç ", text="å…¬å¸ç¼–ç ")
    self.entity_tree.heading("ç±»å‹", text="å…¬å¸ç±»å‹")
    self.entity_tree.heading("æŒè‚¡æ¯”ä¾‹", text="æŒè‚¡æ¯”ä¾‹%")
    self.entity_tree.heading("å±‚çº§", text="å±‚çº§")

    # æ»šåŠ¨æ¡
    scrollbar = ttk.Scrollbar(entity_frame, orient="vertical",
                             command=self.entity_tree.yview)
    self.entity_tree.configure(yscrollcommand=scrollbar.set)

    self.entity_tree.pack(side="left", fill="both", expand=True)
    scrollbar.pack(side="right", fill="y")

    # åŒå‡»äº‹ä»¶
    self.entity_tree.bind("<Double-1>", self.on_entity_double_click)

    # å³é”®èœå•
    self.entity_context_menu = tk.Menu(self.entity_tree, tearoff=0)
    self.entity_context_menu.add_command(label="æŸ¥çœ‹è¯¦æƒ…",
                                        command=self.view_entity_detail)
    self.entity_context_menu.add_command(label="ç¼–è¾‘ä¿¡æ¯",
                                        command=self.edit_entity)
    self.entity_context_menu.add_separator()
    self.entity_context_menu.add_command(label="æ·»åŠ å­å…¬å¸",
                                        command=self.add_sub_entity)
    self.entity_context_menu.add_command(label="è®¾ç½®æŒè‚¡å…³ç³»",
                                        command=self.set_ownership)
    self.entity_context_menu.add_separator()
    self.entity_context_menu.add_command(label="æŸ¥çœ‹è´¢åŠ¡æ•°æ®",
                                        command=self.view_entity_financials)
    self.entity_context_menu.add_command(label="æŸ¥çœ‹å†…éƒ¨äº¤æ˜“",
                                        command=self.view_intercompany_trans)

    self.entity_tree.bind("<Button-3>", self.show_entity_context_menu)

    # åº•éƒ¨: é¡¹ç›®è¯¦æƒ…
    detail_frame = ttk.LabelFrame(right_pane, text="é€‰ä¸­ä¿¡æ¯", padding="5")
    detail_frame.pack(fill="x", pady=(5,0))

    self.entity_detail_text = scrolledtext.ScrolledText(
        detail_frame, height=8, state='disabled'
    )
    self.entity_detail_text.pack(fill="both", expand=True)

    # é…ç½®ç½‘æ ¼æƒé‡
    project_frame.columnconfigure(0, weight=1)
    project_frame.columnconfigure(1, weight=2)
    project_frame.rowconfigure(0, weight=1)
```

#### 2.2 åˆå¹¶æŠ¥è¡¨ç•Œé¢

```python
def create_consolidation_tab(self, parent):
    """åˆ›å»ºåˆå¹¶æŠ¥è¡¨æ ‡ç­¾é¡µ - æ–°å¢"""
    consol_frame = ttk.Frame(parent, padding="10")
    parent.add(consol_frame, text="åˆå¹¶æŠ¥è¡¨")

    # é¡¶éƒ¨: åˆå¹¶å‚æ•°è®¾ç½®
    param_frame = ttk.LabelFrame(consol_frame, text="åˆå¹¶å‚æ•°è®¾ç½®", padding="10")
    param_frame.pack(fill="x", pady=(0,10))

    # ç¬¬ä¸€è¡Œ: é¡¹ç›®å’ŒæœŸé—´é€‰æ‹©
    row1 = ttk.Frame(param_frame)
    row1.pack(fill="x", pady=2)

    ttk.Label(row1, text="é¡¹ç›®:").pack(side="left")
    self.consol_project_var = tk.StringVar()
    ttk.Combobox(row1, textvariable=self.consol_project_var,
                state="readonly", width=30).pack(side="left", padx=5)

    ttk.Label(row1, text="åˆå¹¶æœŸé—´:").pack(side="left", padx=(20,0))
    self.consol_period_var = tk.StringVar(value="2024")
    ttk.Entry(row1, textvariable=self.consol_period_var,
             width=15).pack(side="left", padx=5)

    # ç¬¬äºŒè¡Œ: æ¯å…¬å¸å’Œåˆå¹¶èŒƒå›´
    row2 = ttk.Frame(param_frame)
    row2.pack(fill="x", pady=2)

    ttk.Label(row2, text="æ¯å…¬å¸:").pack(side="left")
    self.consol_parent_var = tk.StringVar()
    ttk.Combobox(row2, textvariable=self.consol_parent_var,
                state="readonly", width=30).pack(side="left", padx=5)

    ttk.Label(row2, text="åˆå¹¶èŒƒå›´:").pack(side="left", padx=(20,0))
    ttk.Button(row2, text="ğŸ“‹ é€‰æ‹©å…¬å¸",
              command=self.select_consolidation_scope).pack(side="left", padx=5)

    self.consol_scope_label = ttk.Label(row2, text="æœªé€‰æ‹©", foreground="gray")
    self.consol_scope_label.pack(side="left", padx=5)

    # ç¬¬ä¸‰è¡Œ: åˆå¹¶æ–¹æ³•å’Œå…¶ä»–é€‰é¡¹
    row3 = ttk.Frame(param_frame)
    row3.pack(fill="x", pady=2)

    ttk.Label(row3, text="åˆå¹¶æ–¹æ³•:").pack(side="left")
    self.consol_method_var = tk.StringVar(value="full")
    ttk.Radiobutton(row3, text="å®Œå…¨åˆå¹¶", variable=self.consol_method_var,
                   value="full").pack(side="left", padx=5)
    ttk.Radiobutton(row3, text="æ¯”ä¾‹åˆå¹¶", variable=self.consol_method_var,
                   value="proportional").pack(side="left", padx=5)

    self.auto_eliminate_var = tk.BooleanVar(value=True)
    ttk.Checkbutton(row3, text="è‡ªåŠ¨ç”ŸæˆæŠµé”€åˆ†å½•",
                   variable=self.auto_eliminate_var).pack(side="left", padx=(20,0))

    # ä¸­éƒ¨: æŠµé”€åˆ†å½•ç®¡ç†
    adjustment_frame = ttk.LabelFrame(consol_frame, text="æŠµé”€åˆ†å½•", padding="5")
    adjustment_frame.pack(fill="both", expand=True, pady=(0,10))

    # å·¥å…·æ 
    adj_toolbar = ttk.Frame(adjustment_frame)
    adj_toolbar.pack(fill="x", pady=(0,5))

    ttk.Button(adj_toolbar, text="ğŸ”„ è‡ªåŠ¨è¯†åˆ«å†…éƒ¨äº¤æ˜“",
              command=self.auto_detect_intercompany).pack(side="left", padx=2)
    ttk.Button(adj_toolbar, text="â• æ‰‹å·¥æ·»åŠ æŠµé”€",
              command=self.add_manual_adjustment).pack(side="left", padx=2)
    ttk.Button(adj_toolbar, text="âœï¸ ç¼–è¾‘",
              command=self.edit_adjustment).pack(side="left", padx=2)
    ttk.Button(adj_toolbar, text="ğŸ—‘ï¸ åˆ é™¤",
              command=self.delete_adjustment).pack(side="left", padx=2)
    ttk.Button(adj_toolbar, text="ğŸ“¥ å¯¼å…¥æŠµé”€æ¨¡æ¿",
              command=self.import_adjustments).pack(side="left", padx=2)

    # æŠµé”€åˆ†å½•åˆ—è¡¨
    self.adjustment_tree = ttk.Treeview(
        adjustment_frame,
        columns=("ç±»å‹", "å…¬å¸å¯¹", "å€Ÿæ–¹ç§‘ç›®", "è´·æ–¹ç§‘ç›®", "é‡‘é¢", "è¯´æ˜"),
        show="headings",
        height=10
    )

    headers = [("ç±»å‹", 100), ("å…¬å¸å¯¹", 200), ("å€Ÿæ–¹ç§‘ç›®", 120),
               ("è´·æ–¹ç§‘ç›®", 120), ("é‡‘é¢", 100), ("è¯´æ˜", 250)]
    for col, width in headers:
        self.adjustment_tree.heading(col, text=col)
        self.adjustment_tree.column(col, width=width)

    adj_scroll_y = ttk.Scrollbar(adjustment_frame, orient="vertical",
                                command=self.adjustment_tree.yview)
    adj_scroll_x = ttk.Scrollbar(adjustment_frame, orient="horizontal",
                                command=self.adjustment_tree.xview)
    self.adjustment_tree.configure(yscrollcommand=adj_scroll_y.set,
                                   xscrollcommand=adj_scroll_x.set)

    self.adjustment_tree.grid(row=1, column=0, sticky="nsew")
    adj_scroll_y.grid(row=1, column=1, sticky="ns")
    adj_scroll_x.grid(row=2, column=0, sticky="ew")

    adjustment_frame.columnconfigure(0, weight=1)
    adjustment_frame.rowconfigure(1, weight=1)

    # åº•éƒ¨: æ“ä½œæŒ‰é’®
    btn_frame = ttk.Frame(consol_frame)
    btn_frame.pack(fill="x")

    ttk.Button(btn_frame, text="ğŸ” é¢„è§ˆåˆå¹¶ç»“æœ",
              command=self.preview_consolidation,
              style='Accent.TButton', width=20).pack(side="left", padx=5)
    ttk.Button(btn_frame, text="ğŸ“Š ç”Ÿæˆåˆå¹¶æŠ¥è¡¨",
              command=self.generate_consolidation_report,
              style='Accent.TButton', width=20).pack(side="left", padx=5)
    ttk.Button(btn_frame, text="ğŸ’¾ ä¿å­˜åˆå¹¶æ–¹æ¡ˆ",
              command=self.save_consolidation_scheme,
              width=18).pack(side="left", padx=5)
    ttk.Button(btn_frame, text="ğŸ“œ æŸ¥çœ‹å†å²åˆå¹¶",
              command=self.view_consolidation_history,
              width=18).pack(side="left", padx=5)
```

#### 2.3 è‡ªç„¶è¯­è¨€æŸ¥è¯¢ç•Œé¢

```python
def create_nl_query_tab(self, parent):
    """åˆ›å»ºè‡ªç„¶è¯­è¨€æŸ¥è¯¢æ ‡ç­¾é¡µ - æ–°å¢"""
    nl_frame = ttk.Frame(parent, padding="10")
    parent.add(nl_frame, text="æ™ºèƒ½æŸ¥è¯¢")

    nl_frame.columnconfigure(0, weight=1)
    nl_frame.rowconfigure(1, weight=1)

    # é¡¶éƒ¨: æŸ¥è¯¢è¾“å…¥åŒº
    input_frame = ttk.LabelFrame(nl_frame, text="è¾“å…¥æŸ¥è¯¢ (æ”¯æŒè‡ªç„¶è¯­è¨€)", padding="10")
    input_frame.grid(row=0, column=0, sticky="ew", pady=(0,10))
    input_frame.columnconfigure(0, weight=1)

    # æŸ¥è¯¢è¾“å…¥æ¡†
    self.nl_query_text = tk.Text(input_frame, height=4, wrap=tk.WORD,
                                 font=('Microsoft YaHei', 10))
    self.nl_query_text.grid(row=0, column=0, sticky="ew", pady=(0,5))

    # æ™ºèƒ½æç¤ºæ ‡ç­¾
    hint_label = ttk.Label(
        input_frame,
        text="ğŸ’¡ ç¤ºä¾‹: \"æŸ¥æ‰¾2024å¹´åŒ—äº¬å…¬å¸çš„æ‰€æœ‰ç®¡ç†è´¹ç”¨å‡­è¯\" / \"å¯¹æ¯”æ¯å­å…¬å¸çš„åº”æ”¶è´¦æ¬¾\" / \"æ˜¾ç¤ºé›†å›¢å†…éƒ¨é‡‡è´­äº¤æ˜“\"",
        font=('Arial', 8),
        foreground='gray'
    )
    hint_label.grid(row=1, column=0, sticky="w")

    # å¿«æ·æŸ¥è¯¢æŒ‰é’®
    quick_frame = ttk.Frame(input_frame)
    quick_frame.grid(row=2, column=0, sticky="ew", pady=(5,0))

    quick_queries = [
        ("ğŸ“‹ æ‰€æœ‰å‡­è¯", "æ˜¾ç¤ºæ‰€æœ‰å‡­è¯"),
        ("ğŸ’° ç§‘ç›®ä½™é¢", "æŸ¥è¯¢ç§‘ç›®ä½™é¢è¡¨"),
        ("ğŸ¢ å…¬å¸å¯¹æ¯”", "å¯¹æ¯”å„å…¬å¸è´¢åŠ¡æ•°æ®"),
        ("ğŸ”— å†…éƒ¨äº¤æ˜“", "æ˜¾ç¤ºå†…éƒ¨äº¤æ˜“æ˜ç»†"),
        ("ğŸ“Š åˆå¹¶æŠ¥è¡¨", "æŸ¥çœ‹åˆå¹¶è´¢åŠ¡æŠ¥è¡¨"),
        ("âš ï¸ å¼‚å¸¸æ•°æ®", "æŸ¥æ‰¾å¼‚å¸¸æˆ–å¯ç–‘æ•°æ®")
    ]

    for i, (text, query) in enumerate(quick_queries):
        ttk.Button(
            quick_frame,
            text=text,
            width=15,
            command=lambda q=query: self.set_nl_query(q)
        ).grid(row=i//3, column=i%3, padx=2, pady=2, sticky="ew")

    for i in range(3):
        quick_frame.columnconfigure(i, weight=1)

    # æŸ¥è¯¢æŒ‰é’®
    query_btn = ttk.Button(
        input_frame,
        text="ğŸ” æ™ºèƒ½æŸ¥è¯¢",
        command=self.execute_nl_query,
        style='Accent.TButton'
    )
    query_btn.grid(row=3, column=0, pady=(10,0))

    # ä¸­éƒ¨: æŸ¥è¯¢ç»“æœæ˜¾ç¤º
    result_frame = ttk.LabelFrame(nl_frame, text="æŸ¥è¯¢ç»“æœ", padding="5")
    result_frame.grid(row=1, column=0, sticky="nsew")
    result_frame.columnconfigure(0, weight=1)
    result_frame.rowconfigure(0, weight=1)

    # åˆ›å»ºNotebookç”¨äºå¤šç§ç»“æœå±•ç¤º
    self.result_notebook = ttk.Notebook(result_frame)
    self.result_notebook.grid(row=0, column=0, sticky="nsew")

    # è¡¨æ ¼è§†å›¾
    table_frame = ttk.Frame(self.result_notebook)
    self.result_notebook.add(table_frame, text="ğŸ“Š è¡¨æ ¼")

    self.nl_result_tree = ttk.Treeview(table_frame, show="headings")
    nl_scroll_y = ttk.Scrollbar(table_frame, orient="vertical",
                               command=self.nl_result_tree.yview)
    nl_scroll_x = ttk.Scrollbar(table_frame, orient="horizontal",
                               command=self.nl_result_tree.xview)
    self.nl_result_tree.configure(yscrollcommand=nl_scroll_y.set,
                                   xscrollcommand=nl_scroll_x.set)

    self.nl_result_tree.grid(row=0, column=0, sticky="nsew")
    nl_scroll_y.grid(row=0, column=1, sticky="ns")
    nl_scroll_x.grid(row=1, column=0, sticky="ew")

    table_frame.columnconfigure(0, weight=1)
    table_frame.rowconfigure(0, weight=1)

    # æ–‡æœ¬è§†å›¾
    text_frame = ttk.Frame(self.result_notebook)
    self.result_notebook.add(text_frame, text="ğŸ“ æ–‡æœ¬")

    self.nl_result_text = scrolledtext.ScrolledText(
        text_frame, wrap=tk.WORD, state='disabled'
    )
    self.nl_result_text.pack(fill="both", expand=True)

    # ç»Ÿè®¡è§†å›¾
    stats_frame = ttk.Frame(self.result_notebook)
    self.result_notebook.add(stats_frame, text="ğŸ“ˆ ç»Ÿè®¡")

    self.nl_stats_text = scrolledtext.ScrolledText(
        stats_frame, wrap=tk.WORD, state='disabled', font=('Courier New', 9)
    )
    self.nl_stats_text.pack(fill="both", expand=True)

    # åº•éƒ¨: æ“ä½œæ 
    action_frame = ttk.Frame(nl_frame)
    action_frame.grid(row=2, column=0, sticky="ew", pady=(5,0))

    ttk.Button(action_frame, text="ğŸ“¤ å¯¼å‡ºç»“æœ",
              command=self.export_nl_result).pack(side="left", padx=2)
    ttk.Button(action_frame, text="ğŸ’¾ ä¿å­˜æŸ¥è¯¢",
              command=self.save_nl_query).pack(side="left", padx=2)
    ttk.Button(action_frame, text="ğŸ“œ æŸ¥è¯¢å†å²",
              command=self.view_query_history).pack(side="left", padx=2)
    ttk.Button(action_frame, text="ğŸ”„ æ¸…ç©º",
              command=self.clear_nl_result).pack(side="left", padx=2)

    # çŠ¶æ€ä¿¡æ¯
    self.nl_status_var = tk.StringVar(value="å°±ç»ª")
    status_label = ttk.Label(action_frame, textvariable=self.nl_status_var,
                            foreground='blue')
    status_label.pack(side="right", padx=5)
```

---

### ä¸‰ã€åç«¯ä¸šåŠ¡é€»è¾‘è®¾è®¡

#### 3.1 é›†å›¢å±‚çº§ç®¡ç†å™¨ (GroupHierarchyManager)

```python
# layer3/group_hierarchy_manager.py

class GroupHierarchyManager:
    """é›†å›¢å±‚çº§ç®¡ç†å™¨ - ç®¡ç†å¤šå±‚çº§å…¬å¸ç»“æ„"""

    def __init__(self, db_path: str):
        self.db_path = db_path
        self.conn = sqlite3.connect(db_path)

    def create_entity(self, project_id: str, entity_data: Dict) -> int:
        """åˆ›å»ºå…¬å¸å®ä½“"""
        # å‚æ•°éªŒè¯å’ŒSQLæ’å…¥é€»è¾‘
        pass

    def add_subsidiary(self, parent_id: int, subsidiary_data: Dict,
                      ownership_pct: float) -> int:
        """æ·»åŠ å­å…¬å¸"""
        # 1. åˆ›å»ºå®ä½“
        # 2. å»ºç«‹å…³ç³»
        # 3. è®¡ç®—å±‚çº§
        # 4. æ›´æ–°hierarchy_path
        pass

    def calculate_hierarchy_path(self, entity_id: int) -> str:
        """è®¡ç®—å±‚çº§è·¯å¾„"""
        # é€’å½’æŸ¥æ‰¾çˆ¶çº§,ç”Ÿæˆpath: 1.2.5.8
        pass

    def get_hierarchy_tree(self, project_id: str, root_entity_id: int = None) -> Dict:
        """è·å–å±‚çº§æ ‘ç»“æ„"""
        # è¿”å›æ ‘å½¢JSONç»“æ„,ç”¨äºGUIå±•ç¤º
        pass

    def get_all_descendants(self, entity_id: int) -> List[int]:
        """è·å–æ‰€æœ‰ä¸‹çº§å…¬å¸(é€’å½’)"""
        pass

    def get_consolidation_scope(self, parent_id: int,
                               include_criteria: Dict = None) -> List[int]:
        """è·å–åˆå¹¶èŒƒå›´"""
        # æ ¹æ®æŒè‚¡æ¯”ä¾‹ã€æ§åˆ¶ç±»å‹ç­‰ç­›é€‰çº³å…¥åˆå¹¶çš„å­å…¬å¸
        pass

    def calculate_effective_ownership(self, parent_id: int,
                                     target_id: int) -> float:
        """è®¡ç®—å®é™…æŒè‚¡æ¯”ä¾‹(è€ƒè™‘å¤šå±‚çº§)"""
        # ä¾‹å¦‚: AæŒB 60%, BæŒC 80%, åˆ™Aå¯¹Cå®é™…æŒè‚¡ 60%*80%=48%
        pass

    def validate_circular_reference(self, parent_id: int, child_id: int) -> bool:
        """éªŒè¯æ˜¯å¦æœ‰å¾ªç¯å¼•ç”¨"""
        pass
```

#### 3.2 åˆå¹¶æŠ¥è¡¨å¼•æ“ (ConsolidationEngine)

```python
# layer3/consolidation_engine.py

class ConsolidationEngine:
    """åˆå¹¶æŠ¥è¡¨å¼•æ“ - æ ¸å¿ƒåˆå¹¶é€»è¾‘"""

    def __init__(self, db_path: str):
        self.db_path = db_path
        self.hierarchy_mgr = GroupHierarchyManager(db_path)

    def generate_consolidated_report(self,
                                     parent_entity_id: int,
                                     period: str,
                                     report_type: str = 'balance_sheet',
                                     options: Dict = None) -> Dict:
        """ç”Ÿæˆåˆå¹¶æŠ¥è¡¨ä¸»æµç¨‹"""

        # 1. ç¡®å®šåˆå¹¶èŒƒå›´
        scope_entities = self._determine_consolidation_scope(
            parent_entity_id, period, options
        )

        # 2. æ”¶é›†å„å…¬å¸è´¢åŠ¡æ•°æ®
        entity_financials = self._collect_entity_financials(
            scope_entities, period, report_type
        )

        # 3. è¯†åˆ«å†…éƒ¨äº¤æ˜“
        intercompany_trans = self._identify_intercompany_transactions(
            scope_entities, period
        )

        # 4. ç”ŸæˆæŠµé”€åˆ†å½•
        adjustments = self._generate_elimination_entries(
            intercompany_trans, entity_financials, options
        )

        # 5. æ‰§è¡Œåˆå¹¶
        consolidated_data = self._perform_consolidation(
            entity_financials, adjustments, options
        )

        # 6. è®¡ç®—å°‘æ•°è‚¡ä¸œæƒç›Š
        minority_interest = self._calculate_minority_interest(
            scope_entities, consolidated_data, options
        )

        # 7. ç”ŸæˆæŠ¥è¡¨
        report = self._format_consolidated_report(
            consolidated_data, minority_interest, report_type
        )

        # 8. ä¿å­˜å…ƒæ•°æ®
        self._save_consolidation_metadata(
            parent_entity_id, period, scope_entities, adjustments
        )

        return report

    def _identify_intercompany_transactions(self, entities: List[int],
                                           period: str) -> pd.DataFrame:
        """è¯†åˆ«å†…éƒ¨äº¤æ˜“ - æ™ºèƒ½åŒ¹é…"""

        # æ–¹æ³•1: åŸºäºäº¤æ˜“å¯¹æ‰‹æ–¹å­—æ®µ(å¦‚æœæœ‰)
        # æ–¹æ³•2: åŸºäºç§‘ç›®å¯¹åº”å…³ç³»(åº”æ”¶vsåº”ä»˜)
        # æ–¹æ³•3: åŸºäºé‡‘é¢å’Œæ—¥æœŸåŒ¹é…
        # æ–¹æ³•4: AIè¾…åŠ©è¯†åˆ«

        query = """
        SELECT
            v1.entity_id as seller_entity_id,
            v2.entity_id as buyer_entity_id,
            v1.voucher_date as transaction_date,
            e1.debit_amount as seller_amount,
            e2.credit_amount as buyer_amount,
            v1.voucher_id as seller_voucher_id,
            v2.voucher_id as buyer_voucher_id
        FROM fact_vouchers v1
        JOIN fact_entries e1 ON v1.voucher_id = e1.voucher_id
        JOIN fact_vouchers v2 ON v2.entity_id != v1.entity_id
        JOIN fact_entries e2 ON v2.voucher_id = e2.voucher_id
        WHERE v1.entity_id IN ({entity_list})
          AND v2.entity_id IN ({entity_list})
          AND v1.fiscal_year = ?
          AND ABS(e1.debit_amount - e2.credit_amount) < 0.01
          AND ABS(julianday(v1.voucher_date) - julianday(v2.voucher_date)) <= 7
          AND (
              (e1.account_code LIKE '1122%' AND e2.account_code LIKE '2202%')  -- åº”æ”¶vsåº”ä»˜
              OR (e1.account_code LIKE '1123%' AND e2.account_code LIKE '2203%')
          )
        """
        pass

    def _generate_elimination_entries(self, transactions: pd.DataFrame,
                                     financials: Dict, options: Dict) -> List[Dict]:
        """ç”ŸæˆæŠµé”€åˆ†å½•"""

        adjustments = []

        # 1. å†…éƒ¨äº¤æ˜“æŠµé”€
        for _, trans in transactions.iterrows():
            adjustments.append({
                'type': 'å†…éƒ¨äº¤æ˜“æŠµé”€',
                'debit_account': trans['seller_account'],
                'credit_account': trans['buyer_account'],
                'amount': trans['amount'],
                'description': f"æŠµé”€{trans['seller_entity']}å‘{trans['buyer_entity']}çš„å†…éƒ¨äº¤æ˜“"
            })

        # 2. å†…éƒ¨å€ºæƒå€ºåŠ¡æŠµé”€
        # SELECTè´¦é¾„åˆ†æ,åŒ¹é…åº”æ”¶åº”ä»˜

        # 3. æœªå®ç°å†…éƒ¨åˆ©æ¶¦æŠµé”€
        # è®¡ç®—å­˜è´§/å›ºå®šèµ„äº§ä¸­çš„æœªå®ç°åˆ©æ¶¦

        # 4. æŠ•èµ„æ”¶ç›ŠæŠµé”€
        # é•¿æœŸè‚¡æƒæŠ•èµ„ vs å­å…¬å¸æƒç›Š

        return adjustments

    def _perform_consolidation(self, entity_financials: Dict,
                              adjustments: List, options: Dict) -> pd.DataFrame:
        """æ‰§è¡Œåˆå¹¶è®¡ç®—"""

        # 1. æ±‡æ€»å„å…¬å¸æ•°æ®
        consolidated = pd.DataFrame()
        for entity_id, data in entity_financials.items():
            if consolidated.empty:
                consolidated = data.copy()
            else:
                # æŒ‰ç§‘ç›®ç¼–ç mergeå¹¶æ±‚å’Œ
                consolidated = pd.merge(
                    consolidated, data,
                    on='ç§‘ç›®ç¼–ç ', how='outer',
                    suffixes=('', f'_entity{entity_id}')
                )
                # æ±‡æ€»é‡‘é¢åˆ—

        # 2. åº”ç”¨æŠµé”€åˆ†å½•
        for adj in adjustments:
            # å€Ÿæ–¹ç§‘ç›®å‡å°‘, è´·æ–¹ç§‘ç›®å‡å°‘
            pass

        return consolidated

    def _calculate_minority_interest(self, entities: List,
                                    consolidated: pd.DataFrame,
                                    options: Dict) -> Dict:
        """è®¡ç®—å°‘æ•°è‚¡ä¸œæƒç›Š"""

        minority_equity = {}

        for entity_id in entities:
            ownership = self.hierarchy_mgr.calculate_effective_ownership(
                parent_id, entity_id
            )
            if ownership < 100:
                minority_pct = 100 - ownership
                # è®¡ç®—è¯¥å®ä½“çš„å‡€èµ„äº§
                entity_equity = ...
                minority_equity[entity_id] = entity_equity * (minority_pct / 100)

        return minority_equity
```

#### 3.3 è‡ªç„¶è¯­è¨€æŸ¥è¯¢å¼•æ“ (NLQueryEngine)

```python
# layer3/nl_query_engine.py

class NLQueryEngine:
    """è‡ªç„¶è¯­è¨€æŸ¥è¯¢å¼•æ“"""

    def __init__(self, db_path: str):
        self.db_path = db_path
        self.intent_patterns = self._load_intent_patterns()
        self.entity_extractor = self._init_entity_extractor()

    def process_query(self, query_text: str, context: Dict = None) -> Dict:
        """å¤„ç†è‡ªç„¶è¯­è¨€æŸ¥è¯¢"""

        # 1. æ„å›¾è¯†åˆ«
        intent = self._identify_intent(query_text)

        # 2. å®ä½“æŠ½å–
        entities = self._extract_entities(query_text, context)

        # 3. ç”ŸæˆSQL
        sql = self._generate_sql(intent, entities)

        # 4. æ‰§è¡ŒæŸ¥è¯¢
        result = self._execute_query(sql)

        # 5. æ ¼å¼åŒ–ç»“æœ
        formatted = self._format_result(result, intent)

        return {
            'success': True,
            'intent': intent,
            'entities': entities,
            'sql': sql,
            'result': formatted,
            'row_count': len(result)
        }

    def _identify_intent(self, query: str) -> str:
        """è¯†åˆ«æŸ¥è¯¢æ„å›¾"""

        intents = {
            'voucher_query': ['å‡­è¯', 'è®°è´¦', 'åˆ†å½•', 'voucher'],
            'account_balance': ['ä½™é¢', 'ç§‘ç›®', 'è´¦ç›®', 'balance'],
            'intercompany': ['å†…éƒ¨', 'å…³è”', 'å¾€æ¥', 'intercompany'],
            'consolidation': ['åˆå¹¶', 'æ±‡æ€»', 'é›†å›¢', 'consolidation'],
            'comparison': ['å¯¹æ¯”', 'æ¯”è¾ƒ', 'compare', 'vs'],
            'anomaly': ['å¼‚å¸¸', 'å¯ç–‘', 'é”™è¯¯', 'anomaly'],
            'entity_info': ['å…¬å¸ä¿¡æ¯', 'ç»„ç»‡', 'æœºæ„'],
        }

        scores = {}
        for intent_name, keywords in intents.items():
            score = sum(1 for kw in keywords if kw in query.lower())
            if score > 0:
                scores[intent_name] = score

        if scores:
            return max(scores, key=scores.get)
        return 'general_query'

    def _extract_entities(self, query: str, context: Dict) -> Dict:
        """æŠ½å–æŸ¥è¯¢å®ä½“"""

        entities = {}

        # 1. æ—¥æœŸ/æœŸé—´
        date_patterns = [
            r'(\d{4})å¹´',
            r'(\d{4})-(\d{2})',
            r'(\d{4})å¹´(\d{1,2})æœˆ'
        ]
        for pattern in date_patterns:
            match = re.search(pattern, query)
            if match:
                entities['period'] = match.group(0)
                break

        # 2. å…¬å¸åç§°
        # æŸ¥è¯¢æ•°æ®åº“ä¸­çš„å…¬å¸åˆ—è¡¨,æ¨¡ç³ŠåŒ¹é…
        conn = sqlite3.connect(self.db_path)
        company_names = pd.read_sql(
            "SELECT entity_id, entity_name FROM entities", conn
        )
        conn.close()

        for _, row in company_names.iterrows():
            if row['entity_name'] in query:
                entities['entity'] = row['entity_id']
                entities['entity_name'] = row['entity_name']
                break

        # 3. ç§‘ç›®åç§°/ç¼–ç 
        account_keywords = re.findall(r'[ä¸€-é¾¥]+è´¹ç”¨|åº”æ”¶|åº”ä»˜|å­˜è´§|ç°é‡‘|é“¶è¡Œ', query)
        if account_keywords:
            entities['account_keyword'] = account_keywords[0]

        # 4. é‡‘é¢èŒƒå›´
        amount_match = re.search(r'([å¤§å°è¶…]äº|ä»¥ä¸Š|ä»¥ä¸‹)\s*(\d+(?:,\d{3})*(?:\.\d+)?)\s*(å…ƒ|ä¸‡|äº¿)?', query)
        if amount_match:
            entities['amount_condition'] = amount_match.group(0)

        return entities

    def _generate_sql(self, intent: str, entities: Dict) -> str:
        """ç”ŸæˆSQLæŸ¥è¯¢"""

        sql_templates = {
            'voucher_query': """
                SELECT v.voucher_date as æ—¥æœŸ,
                       v.voucher_number as å‡­è¯å·,
                       e.account_code as ç§‘ç›®ç¼–ç ,
                       a.account_name as ç§‘ç›®åç§°,
                       e.summary as æ‘˜è¦,
                       e.debit_amount as å€Ÿæ–¹é‡‘é¢,
                       e.credit_amount as è´·æ–¹é‡‘é¢,
                       ent.entity_name as å…¬å¸
                FROM fact_vouchers v
                JOIN fact_entries e ON v.voucher_id = e.voucher_id
                LEFT JOIN dim_accounts a ON e.account_code = a.account_code
                LEFT JOIN entities ent ON v.entity_id = ent.entity_id
                WHERE 1=1
                {period_filter}
                {entity_filter}
                {account_filter}
                ORDER BY v.voucher_date DESC, v.voucher_number
                LIMIT 1000
            """,

            'account_balance': """
                SELECT
                    a.account_code as ç§‘ç›®ç¼–ç ,
                    a.account_name as ç§‘ç›®åç§°,
                    SUM(CASE WHEN e.debit_amount > 0 THEN e.debit_amount ELSE 0 END) as å€Ÿæ–¹å‘ç”Ÿé¢,
                    SUM(CASE WHEN e.credit_amount > 0 THEN e.credit_amount ELSE 0 END) as è´·æ–¹å‘ç”Ÿé¢,
                    SUM(e.debit_amount - e.credit_amount) as ä½™é¢
                FROM fact_entries e
                JOIN dim_accounts a ON e.account_code = a.account_code
                JOIN fact_vouchers v ON e.voucher_id = v.voucher_id
                WHERE 1=1
                {period_filter}
                {entity_filter}
                GROUP BY a.account_code, a.account_name
                ORDER BY a.account_code
            """,

            'intercompany': """
                SELECT
                    it.transaction_date as äº¤æ˜“æ—¥æœŸ,
                    e1.entity_name as é”€å”®æ–¹,
                    e2.entity_name as è´­ä¹°æ–¹,
                    it.transaction_type as äº¤æ˜“ç±»å‹,
                    it.amount as äº¤æ˜“é‡‘é¢,
                    it.description as è¯´æ˜
                FROM intercompany_transactions it
                JOIN entities e1 ON it.seller_entity_id = e1.entity_id
                JOIN entities e2 ON it.buyer_entity_id = e2.entity_id
                WHERE 1=1
                {period_filter}
                ORDER BY it.transaction_date DESC
            """
        }

        # é€‰æ‹©æ¨¡æ¿
        template = sql_templates.get(intent, sql_templates['voucher_query'])

        # æ„å»ºè¿‡æ»¤æ¡ä»¶
        filters = {}

        if 'period' in entities:
            period = entities['period']
            if len(period) == 4:  # å¹´ä»½
                filters['period_filter'] = f"AND strftime('%Y', v.voucher_date) = '{period}'"
            else:
                filters['period_filter'] = f"AND v.fiscal_year = '{period}'"
        else:
            filters['period_filter'] = ""

        if 'entity' in entities:
            filters['entity_filter'] = f"AND v.entity_id = {entities['entity']}"
        else:
            filters['entity_filter'] = ""

        if 'account_keyword' in entities:
            keyword = entities['account_keyword']
            filters['account_filter'] = f"AND a.account_name LIKE '%{keyword}%'"
        else:
            filters['account_filter'] = ""

        # å¡«å……æ¨¡æ¿
        sql = template.format(**filters)

        return sql

    def _execute_query(self, sql: str) -> pd.DataFrame:
        """æ‰§è¡ŒSQLæŸ¥è¯¢"""
        try:
            conn = sqlite3.connect(self.db_path)
            result = pd.read_sql_query(sql, conn)
            conn.close()
            return result
        except Exception as e:
            logger.error(f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {e}")
            return pd.DataFrame()

    def _format_result(self, df: pd.DataFrame, intent: str) -> Dict:
        """æ ¼å¼åŒ–æŸ¥è¯¢ç»“æœ"""

        if df.empty:
            return {
                'message': 'æœªæ‰¾åˆ°åŒ¹é…çš„æ•°æ®',
                'data': df,
                'stats': {}
            }

        # ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯
        stats = {
            'è®°å½•æ•°': len(df),
            'æŸ¥è¯¢æ—¶é—´': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        }

        # æ ¹æ®æ„å›¾ç”Ÿæˆç‰¹å®šç»Ÿè®¡
        if intent == 'account_balance':
            if 'ä½™é¢' in df.columns:
                stats['ä½™é¢åˆè®¡'] = f"{df['ä½™é¢'].sum():,.2f}"

        if intent == 'voucher_query':
            if 'å€Ÿæ–¹é‡‘é¢' in df.columns:
                stats['å€Ÿæ–¹åˆè®¡'] = f"{df['å€Ÿæ–¹é‡‘é¢'].sum():,.2f}"
            if 'è´·æ–¹é‡‘é¢' in df.columns:
                stats['è´·æ–¹åˆè®¡'] = f"{df['è´·æ–¹é‡‘é¢'].sum():,.2f}"

        return {
            'message': f'æŸ¥è¯¢æˆåŠŸ,æ‰¾åˆ° {len(df)} æ¡è®°å½•',
            'data': df,
            'stats': stats
        }
```

---

### å››ã€å®æ–½æ­¥éª¤

#### é˜¶æ®µä¸€: æ•°æ®åº“å‡çº§ (2-3å¤©)

1. åˆ›å»ºæ–°è¡¨ç»“æ„
2. æ•°æ®è¿ç§»è„šæœ¬
3. ç´¢å¼•ä¼˜åŒ–
4. æµ‹è¯•æ•°æ®éªŒè¯

#### é˜¶æ®µäºŒ: åç«¯åŠŸèƒ½å¼€å‘ (5-7å¤©)

1. GroupHierarchyManagerå®ç°
2. ConsolidationEngineå®ç°
3. NLQueryEngineå®ç°
4. å•å…ƒæµ‹è¯•ç¼–å†™

#### é˜¶æ®µä¸‰: GUIç•Œé¢å¼€å‘ (4-5å¤©)

1. é¡¹ç›®ç®¡ç†ç•Œé¢å‡çº§
2. åˆå¹¶æŠ¥è¡¨ç•Œé¢å¼€å‘
3. æ™ºèƒ½æŸ¥è¯¢ç•Œé¢å¼€å‘
4. ç•Œé¢è”è°ƒæµ‹è¯•

#### é˜¶æ®µå››: é›†æˆæµ‹è¯• (2-3å¤©)

1. ç«¯åˆ°ç«¯åŠŸèƒ½æµ‹è¯•
2. æ€§èƒ½æµ‹è¯•
3. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
4. æ–‡æ¡£ç¼–å†™

---

## âš¡ å¿«é€ŸåŸå‹æ–¹æ¡ˆ (å…ˆçœ‹æ•ˆæœ)

å¦‚æœæ‚¨æƒ³å…ˆçœ‹åˆ°æ•ˆæœ,æˆ‘å»ºè®®åˆ†æ­¥å®æ–½:

### ç¬¬ä¸€æ­¥: åŸºç¡€å¤šå…¬å¸æ”¯æŒ (1-2å¤©)
- åªæ·»åŠ entitiesè¡¨
- GUIä¸Šæ·»åŠ ç®€å•çš„å…¬å¸ç®¡ç†ç•Œé¢
- å‡­è¯/ç§‘ç›®å…³è”entity_id

### ç¬¬äºŒæ­¥: ç®€åŒ–åˆå¹¶æŠ¥è¡¨ (2-3å¤©)
- åªåšæ•°æ®æ±‡æ€»,æš‚ä¸åšæŠµé”€
- ç”Ÿæˆç®€å•çš„åˆå¹¶æŠ¥è¡¨
- éªŒè¯å¤šå±‚çº§ç»“æ„

### ç¬¬ä¸‰æ­¥: åŸºç¡€NLæŸ¥è¯¢ (2-3å¤©)
- å®ç°å…³é”®è¯åŒ¹é…
- ç”ŸæˆåŸºæœ¬SQL
- å±•ç¤ºæŸ¥è¯¢ç»“æœ

### ç¬¬å››æ­¥: å®Œå–„åŠŸèƒ½ (æŒ‰éœ€)
- è‡ªåŠ¨æŠµé”€
- æ™ºèƒ½è¯†åˆ«
- é«˜çº§æŸ¥è¯¢

---

## ğŸ’¬ æ‚¨çš„æ„è§?

è¯·å‘Šè¯‰æˆ‘:

1. **è¿™ä¸ªæ–¹æ¡ˆæ˜¯å¦ç¬¦åˆæ‚¨çš„éœ€æ±‚?**
2. **æ˜¯å¦éœ€è¦è°ƒæ•´æŸäº›è®¾è®¡?**
3. **æƒ³å…ˆå®ç°å“ªä¸ªéƒ¨åˆ†?** (å®Œæ•´æ–¹æ¡ˆ vs å¿«é€ŸåŸå‹)
4. **å¯¹äºåˆå¹¶æŠ¥è¡¨çš„æŠµé”€è§„åˆ™,æœ‰ä»€ä¹ˆç‰¹æ®Šè¦æ±‚å—?**
5. **è‡ªç„¶è¯­è¨€æŸ¥è¯¢éœ€è¦æ”¯æŒå“ªäº›å…¸å‹åœºæ™¯?**

æˆ‘ä¼šæ ¹æ®æ‚¨çš„åé¦ˆè°ƒæ•´æ–¹æ¡ˆå¹¶å¼€å§‹å®æ–½! ğŸš€
