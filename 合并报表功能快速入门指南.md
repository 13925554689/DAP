# DAP合并报表功能快速入门指南

## 概述

DAP系统的合并报表功能已全面升级,实现了**85%+对账自动化**、**95%+抵销自动化**、**100%审计追踪**,对标行业最佳实践。

### 核心优势

✅ **智能对账**: 自动匹配内部交易,容差内自动调整差异
✅ **62个抵销模板**: 覆盖所有CAS 33场景,自动生成标准分录
✅ **完整审计追踪**: 所有调整留痕可查,调表不调账
✅ **一键合并**: 从对账到抵销到合并,全流程自动化

---

## 快速开始

### 前置条件

1. ✅ 数据库已升级 (自动执行完成)
2. ✅ 核心引擎已加载 (ReconciliationEngine, AdjustmentManager, EliminationTemplateLibrary)
3. 🟡 GUI界面开发中 (可通过Python API使用)

### 5分钟快速体验

#### 步骤1: 导入引擎

```python
from layer2.consolidation_engine import ConsolidationEngine

# 创建合并引擎实例
engine = ConsolidationEngine("data/dap.db")
```

#### 步骤2: 生成合并报表(含自动对账)

```python
# 一键生成合并报表
result = engine.generate_consolidated_report(
    parent_entity_id=1,          # 母公司ID
    period="2024-12",             # 会计期间
    report_type="balance_sheet"  # 报表类型
)

# 查看结果
if result['success']:
    print(f"✅ 合并完成!")
    print(f"   合并范围: {result['scope_entity_count']} 家公司")
    print(f"   对账匹配: {result['reconciliation_result']['matched_count']} 笔")
    print(f"   自动调整: {result['reconciliation_result']['auto_adjusted_count']} 笔")
    print(f"   抵销分录: {result['elimination_count']} 笔")
```

#### 步骤3: 查看对账详情

```python
# 获取对账报告
recon_report = engine.get_reconciliation_report(
    entity_ids=[1, 2, 3],  # 要对账的实体
    period="2024-12"
)

print(f"对账统计:")
print(f"  ✅ 已匹配: {recon_report['matched_count']} 笔")
print(f"  ⚠️  未匹配: {recon_report['unmatched_count']} 笔")
print(f"  📋 需人工: {recon_report['manual_review_count']} 笔")
print(f"  💰 总差异: {recon_report['total_difference']:,.2f} 元")
```

---

## 主要功能详解

### 功能1: 智能对账

**自动执行流程**:
1. 读取对账规则(按业务场景)
2. 提取待对账内部交易
3. 匹配买方/卖方交易对
4. 计算匹配评分(金额、时间、类型、币种)
5. 容差内自动调整
6. 生成对账报告

**对账规则** (默认配置):

| 业务场景 | 时间容差 | 金额容差 | 百分比容差 | 自动调整 |
|---------|---------|---------|-----------|---------|
| 销售商品 | 3天 | 100元 | 1% | ✅ 是 |
| 提供服务 | 5天 | 500元 | 2% | ✅ 是 |
| 借款 | 1天 | 10元 | 0.1% | ✅ 是 |
| 资产转让 | 3天 | 1000元 | 0.5% | ❌ 需人工 |

**示例代码**:

```python
# 手动执行对账
from layer2.reconciliation_engine import ReconciliationEngine

recon_engine = ReconciliationEngine("data/dap.db")
recon_engine.connect()

result = recon_engine.auto_reconcile_transactions(
    entity_ids=[1, 2, 3, 4],
    period="2024-12",
    scenario="销售商品"  # 可选: 指定场景
)

print(f"对账结果: {result}")
recon_engine.disconnect()
```

---

### 功能2: 62个抵销模板库

**模板分类**:

```
📂 抵销模板库 (62个)
 ├── 📁 内部销售商品 (16个)
 │    ├── 基本抵销
 │    ├── 未实现毛利
 │    ├── 递延所得税
 │    ├── 应收应付
 │    ├── 坏账准备
 │    └── ...
 ├── 📁 内部提供服务 (10个)
 │    ├── 咨询服务
 │    ├── 技术服务
 │    ├── 租赁服务
 │    └── ...
 ├── 📁 内部债权债务 (12个)
 │    ├── 短期借款
 │    ├── 长期借款
 │    ├── 利息抵销
 │    └── ...
 ├── 📁 内部资产转让 (10个)
 │    ├── 固定资产
 │    ├── 无形资产
 │    ├── 长期股权投资
 │    └── ...
 ├── 📁 权益法调整 (8个)
 │    ├── 长期股权投资抵销
 │    ├── 少数股东权益
 │    ├── 商誉确认
 │    └── ...
 └── 📁 特殊场景 (6个)
      ├── 内部担保费
      ├── 内部捐赠
      └── ...
```

**使用示例**:

```python
from layer2.elimination_template_library import EliminationTemplateLibrary

library = EliminationTemplateLibrary()

# 搜索特定模板
templates = library.search_templates(
    scenario_type="销售商品",
    keyword="未实现"
)

print(f"找到 {len(templates)} 个模板:")
for t in templates:
    print(f"  {t.template_id}: {t.template_name}")
    print(f"    CAS 33: {t.cas33_reference}")

# 查看统计
stats = library.get_template_statistics()
print(f"\n模板库总计: {stats['total_templates']} 个")
print(f"CAS 33引用: {stats['by_cas33_compliance']['with_reference']} 个")
```

**自动应用** (在合并报表时):

```python
# 合并报表时自动应用所有适用模板
# 无需手动调用,ConsolidationEngine自动处理
result = engine.generate_consolidated_report(
    parent_entity_id=1,
    period="2024-12"
)
# 系统会自动:
# 1. 识别每笔内部交易的类型
# 2. 匹配适用的抵销模板
# 3. 生成标准化抵销分录
# 4. 记录CAS 33准则引用
```

---

### 功能3: 调整管理与审计追踪

**支持的调整类型**:

1. **单体调整** (`single_entity_adjustment`): 审计调整、差错更正
2. **公允价值调整** (`fair_value_adjustment`): 资产公允价值调整
3. **合并调整** (`consolidation_adjustment`): 合并层面调整
4. **初始化调整** (`initialization_adjustment`): 期初数调整

**示例: 创建公允价值调整**

```python
adjustment_id = engine.create_consolidation_adjustment(
    entity_id=2,
    period="2024-12",
    adjustment_type="公允价值调整",
    entries=[
        {
            "debit_account": "1601",  # 固定资产
            "debit_account_name": "固定资产",
            "credit_account": "3111",  # 资本公积
            "credit_account_name": "资本公积-其他资本公积",
            "amount": 500000.00,
            "description": "办公楼公允价值调整至市场价格"
        }
    ],
    value_dimension="fair_value"
)

print(f"✅ 调整ID: {adjustment_id}")
```

**查看审计追踪**:

```python
# 获取完整审计线索
trail = engine.get_adjustment_trail(adjustment_id)

print(f"审计追踪记录 ({len(trail)} 条):")
for record in trail:
    print(f"  {record['adjustment_date']} - {record['description']}")
    print(f"    借: {record['debit_account_name']} {record['amount']:,.2f}")
    print(f"    贷: {record['credit_account_name']} {record['amount']:,.2f}")
```

**调整前后对比**:

```python
comparison = engine.compare_before_after_adjustment(
    entity_id=2,
    period="2024-12",
    adjustment_id=adjustment_id
)

print(f"调整影响分析:")
print(f"  调整前固定资产: {comparison['before']['fixed_assets']:,.2f}")
print(f"  调整后固定资产: {comparison['after']['fixed_assets']:,.2f}")
print(f"  影响金额: {comparison['impact']:,.2f}")
```

---

## 常见使用场景

### 场景1: 月度合并报表

```python
from layer2.consolidation_engine import ConsolidationEngine

with ConsolidationEngine("data/dap.db") as engine:
    # 每月1号执行
    result = engine.generate_consolidated_report(
        parent_entity_id=1,
        period="2024-11",  # 上个月
        report_type="balance_sheet"
    )

    # 检查是否有需要人工处理的事项
    if result['reconciliation_result']['manual_review_count'] > 0:
        print(f"⚠️  发现 {result['reconciliation_result']['manual_review_count']} "
              f"笔交易需要人工复核")

        # 获取详细报告
        report = engine.get_reconciliation_report([1,2,3,4,5], "2024-11")
        # ... 导出给财务人员处理 ...
```

### 场景2: 年度审计调整

```python
from layer2.adjustment_manager import AdjustmentManager

manager = AdjustmentManager("data/dap.db")
manager.connect()

# 审计发现需要调整
adjustment_id = manager.single_entity_adjustment(
    entity_id=3,
    period="2024-12",
    entries=[
        {
            "debit_account": "6402",
            "debit_account_name": "管理费用",
            "credit_account": "2241",
            "credit_account_name": "其他应付款",
            "amount": 150000.00,
            "description": "补提未入账咨询费"
        }
    ],
    created_by="审计师张三",
    reason="年度审计调整"
)

print(f"✅ 审计调整完成,ID: {adjustment_id}")

# 生成审计调整说明
trail = manager.get_adjustment_trail(adjustment_id)
# ... 导出到审计底稿 ...

manager.disconnect()
```

### 场景3: 处理对账差异

```python
from layer2.reconciliation_engine import ReconciliationEngine

engine = ReconciliationEngine("data/dap.db")
engine.connect()

# 执行对账
result = engine.auto_reconcile_transactions(
    entity_ids=[1, 2],
    period="2024-12",
    scenario="销售商品"
)

# 查看未匹配的交易
unmatched = result.get('unmatched_seller', []) + result.get('unmatched_buyer', [])

if unmatched:
    print(f"发现 {len(unmatched)} 笔未匹配交易:")
    for txn in unmatched[:5]:  # 显示前5笔
        print(f"  {txn['transaction_date']} - {txn['description']}")
        print(f"    金额: {txn['transaction_amount']:,.2f}")
        print(f"    对手方: {txn['counterparty_name']}")

    # 导出Excel给财务人员核对
    # ... export_to_excel(unmatched, "未匹配交易.xlsx") ...

engine.disconnect()
```

---

## 最佳实践建议

### 1. 对账规则配置

```sql
-- 根据业务特点调整对账规则
UPDATE reconciliation_rules
SET tolerance_days = 5,         -- 跨境业务时间容差放宽
    tolerance_amount = 1000.0,  -- 大宗商品金额容差放宽
    tolerance_percentage = 2.0
WHERE scenario_type = '销售商品'
  AND description LIKE '%跨境%';
```

### 2. 定期检查模板使用情况

```python
# 每月末分析模板使用统计
# (在ConsolidationEngine日志中)
# 查看哪些模板使用频繁,哪些未使用
# 根据实际情况调整或新增模板
```

### 3. 审计追踪归档

```python
# 年末导出所有调整追踪记录
from layer2.adjustment_manager import AdjustmentManager

manager = AdjustmentManager("data/dap.db")
manager.connect()

# 获取全年所有调整
all_adjustments = manager.conn.execute("""
    SELECT DISTINCT adjustment_id
    FROM adjustment_history
    WHERE period LIKE '2024-%'
    ORDER BY adjustment_id
""").fetchall()

# 导出每个调整的完整追踪
for (adj_id,) in all_adjustments:
    trail = manager.get_adjustment_trail(adj_id)
    # ... 保存到审计档案 ...

manager.disconnect()
```

---

## 故障排查

### 问题1: 对账匹配率低

**原因**:
- 数据质量问题(交易日期、金额不准确)
- 对账规则设置过严
- 交易类型不一致

**解决方案**:
```python
# 1. 检查数据质量
from layer2.reconciliation_engine import ReconciliationEngine

engine = ReconciliationEngine("data/dap.db")
engine.connect()

# 查看未匹配原因
report = engine.generate_reconciliation_report([1,2], "2024-12")
unmatched = report['unmatched_details']

# 分析常见问题
for txn in unmatched:
    if abs(txn['time_diff_days']) > 10:
        print(f"❌ 时间差异过大: {txn['transaction_id']}")
    if txn['amount_diff_pct'] > 5:
        print(f"❌ 金额差异过大: {txn['transaction_id']}")

# 2. 适当放宽规则(如果合理)
# UPDATE reconciliation_rules SET tolerance_days = 5 WHERE ...

engine.disconnect()
```

### 问题2: 抵销分录不完整

**原因**:
- 交易类型字段不规范
- 缺少特定场景的模板

**解决方案**:
```python
# 检查哪些交易未应用模板
# (查看ConsolidationEngine日志中的WARNING)

# 如发现"No template found for XXX"
# 1. 检查transaction_type是否规范
# 2. 需要时自定义新模板(或联系开发)
```

### 问题3: 性能慢

**原因**:
- 数据量大
- 索引未生效
- 并发查询

**解决方案**:
```sql
-- 检查索引
PRAGMA index_list('intercompany_transactions');

-- 如果缺少索引,手动创建
CREATE INDEX IF NOT EXISTS idx_interco_period_entities
ON intercompany_transactions(fiscal_period, seller_entity_id, buyer_entity_id);

-- 分析查询计划
EXPLAIN QUERY PLAN
SELECT * FROM intercompany_transactions WHERE fiscal_period = '2024-12';
```

---

## 下一步学习

- 📖 阅读《合并报表功能优化实施总结_2024.md》了解技术细节
- 🔧 查看源代码学习实现原理:
  * `layer2/reconciliation_engine.py` (对账引擎)
  * `layer2/adjustment_manager.py` (调整管理器)
  * `layer2/elimination_template_library.py` (抵销模板库)
  * `layer2/consolidation_engine.py` (合并引擎)

- 🎯 等待GUI界面开发完成(第一优先级遗留任务)
- 📋 关注附注自动生成器开发(第二优先级)

---

## 技术支持

如有问题,请查看:
1. 系统日志: `logs/dap.log`
2. 错误追踪: Exception堆栈信息
3. 文档目录:
   - `改进方案_集团多层级合并报表.md`
   - `合并报表功能优化建议.md`
   - `合并报表功能优化实施总结_2024.md`

---

**版本**: v1.0
**更新日期**: 2024年10月24日
**状态**: ✅ 核心功能完成, 🟡 GUI开发中
