# DAP系统 - 合并报表功能使用指南

## 🎉 新功能概述

DAP系统已成功升级,新增了强大的集团合并报表功能! 本指南将帮助您快速上手这些新功能。

---

## ✨ 新增功能

### 1. 📊 项目与实体管理

**功能特性**:
- 多层级公司架构管理 (支持6+层级)
- 母子公司、控股、参股关系维护
- 持股比例和有效持股计算
- 层级树形可视化展示

**使用场景**:
- 集团公司多层级架构管理
- 母子公司投资关系维护
- 合并范围确定

### 2. 📈 合并报表生成

**功能特性**:
- 自动识别内部交易
- 智能生成抵销分录
- 支持4种抵销类型:
  - 内部销售商品抵销
  - 内部服务收入抵销
  - 内部债权债务抵销
  - 资产转让未实现利润抵销
- 少数股东权益自动计算
- 生成合并资产负债表、利润表、现金流量表

**使用场景**:
- 集团合并财务报表编制
- 内部交易抵销处理
- 少数股东权益计算

### 3. 💬 自然语言查询

**功能特性**:
- 支持任意格式自然语言查询
- 智能识别7种查询意图
- 自动提取查询实体(日期、金额、科目等)
- 查询历史记录
- 结果一键导出

**使用场景**:
- 快速查询凭证、科目、余额
- 数据分析和探索
- 非技术人员数据查询

---

## 🚀 快速开始

### 第一步: 系统升级

运行升级脚本:

```bash
python upgrade_consolidation_features.py
```

该脚本会:
1. ✅ 升级数据库架构 (添加5个新表)
2. ✅ 测试核心模块
3. ✅ 生成GUI集成脚本

### 第二步: 集成GUI

**方法A: 自动集成** (推荐)

```bash
python integrate_new_tabs.py
```

**方法B: 手动集成**

1. 打开 `dap_launcher.py`
2. 在顶部导入部分添加:

```python
from gui_consolidation_tabs import (
    EnhancedProjectManagementTab,
    ConsolidationReportTab,
    NLQueryTab
)
```

3. 在 `create_main_area()` 方法中添加:

```python
# 增强的项目管理
enhanced_pm_tab = EnhancedProjectManagementTab(notebook, self.dap_engine)

# 合并报表
consolidation_tab = ConsolidationReportTab(notebook, self.dap_engine)

# 自然语言查询
nl_query_tab = NLQueryTab(notebook, self.dap_engine)
```

### 第三步: 启动系统

```bash
start_gui.bat
```

---

## 📖 详细使用说明

### 功能一: 项目与实体管理

#### 创建项目

1. 切换到 **"📊 项目与实体管理"** 标签页
2. 点击 **"➕ 新建项目"** 按钮
3. 填写项目信息:
   - 项目名称 (必填)
   - 项目编码
   - 客户名称
   - 会计年度
4. 点击 **"保存"**

#### 添加公司实体

1. 选择一个项目
2. 点击 **"➕ 添加公司"** 按钮
3. 填写实体信息:
   - 公司编码 (必填)
   - 公司名称 (必填)
   - 实体类型 (母公司/子公司/孙公司等)
4. 点击 **"保存"**

#### 添加子公司

1. 在实体树中选择母公司
2. 点击 **"➕ 添加子公司"** 按钮
3. 填写子公司信息:
   - 公司编码、名称
   - 持股比例 (%)
   - 投资金额
4. 点击 **"保存"**

系统会自动:
- 计算层级深度
- 计算有效持股比例
- 确定合并方法
- 更新层级路径

#### 查看层级统计

点击 **"📊 查看层级统计"** 查看:
- 总实体数
- 最大层级深度
- 按层级分布
- 按类型分布

---

### 功能二: 合并报表生成

#### 设置合并参数

1. 切换到 **"📊 合并报表"** 标签页
2. 设置参数:
   - **母公司实体**: 选择合并的顶层实体
   - **合并期间**: 输入期间 (格式: YYYY-MM)
   - **报表类型**: 选择资产负债表/利润表/现金流量表
   - **最低持股比例**: 设置合并门槛 (默认20%)
   - **合并方法**: 勾选全额合并/比例合并/权益法

#### 生成合并报表

1. 确认参数设置
2. 点击 **"🚀 生成合并报表"**
3. 查看处理进度:
   - 合并范围 (包含多少个实体)
   - 识别的内部交易数量
   - 生成的抵销分录数量
   - 少数股东权益金额
4. 查看合并结果 (科目级汇总)

#### 导出合并报表

点击 **"💾 导出报表"**,选择保存位置,生成Excel文件。

#### 查看抵销分录

点击 **"📋 查看抵销分录"** 查看详细的抵销会计分录。

#### 查看少数股东权益

点击 **"📊 查看少数股东权益"** 查看各子公司的少数股东权益计算明细。

---

### 功能三: 自然语言查询

#### 执行查询

1. 切换到 **"💬 自然语言查询"** 标签页
2. 在查询输入框输入您的问题,例如:
   - "查询2024年12月的全部凭证"
   - "查询主营业务收入科目余额"
   - "查询超过10万元的凭证"
   - "查询管理费用明细"
3. 按回车或点击 **"🔍 查询"** 按钮
4. 查看查询结果

系统会自动:
- 识别查询意图 (凭证/科目/余额/明细/汇总等)
- 提取关键实体 (日期、金额、科目名称)
- 生成SQL查询
- 展示结果

#### 使用快捷查询

点击预设的快捷查询按钮:
- 查询本月全部凭证
- 查询主营业务收入余额
- 查询管理费用明细
- 查询应收账款汇总
- 查询现金和银行存款
- 查询固定资产明细

#### 查询历史

- 系统自动记录查询历史
- 双击历史记录可重新执行查询

#### 导出查询结果

点击 **"💾 导出结果"**,将查询结果导出为Excel文件。

---

## 💡 使用技巧

### 技巧1: 构建多层级架构

建议顺序:
1. 先创建母公司 (顶层实体)
2. 逐层添加子公司
3. 每添加一层,检查层级树是否正确
4. 使用"查看层级统计"确认结构

### 技巧2: 合并报表准备

在生成合并报表前:
1. ✅ 确保所有实体数据已导入
2. ✅ 检查持股比例设置
3. ✅ 标记内部交易 (如有手工标记功能)
4. ✅ 确认会计期间一致

### 技巧3: 自然语言查询技巧

**有效的查询示例**:
- ✅ "查询2024年12月的凭证"
- ✅ "查询应收账款余额"
- ✅ "查询超过10万的费用"
- ✅ "查询管理费用明细账"

**包含的关键信息**:
- 时间范围 (年、月、日期)
- 科目名称或编码
- 金额条件
- 查询类型 (凭证、余额、明细等)

### 技巧4: 合并报表分析

生成合并报表后:
1. 导出Excel文件
2. 与单体报表对比
3. 检查抵销分录合理性
4. 核对少数股东权益
5. 进行多期对比分析

---

## ⚙️ 技术架构

### 数据库表结构

新增5个表:

1. **entities** - 实体表
   - 存储公司实体信息
   - 层级关系
   - 持股比例

2. **entity_relationships** - 关系表
   - 投资关系详情
   - 投资时间和金额

3. **intercompany_transactions** - 内部交易表
   - 内部销售、借款、资产转让等
   - 抵销状态跟踪

4. **consolidation_adjustments** - 抵销分录表
   - 合并工作底稿调整
   - 借贷科目和金额

5. **consolidation_metadata** - 合并元数据表
   - 合并历史记录
   - 合并范围和结果摘要

### 核心引擎

1. **GroupHierarchyManager** (`layer2/`)
   - 层级管理
   - 持股计算
   - 合并范围确定

2. **ConsolidationEngine** (`layer2/`)
   - 内部交易识别
   - 抵销分录生成
   - 合并计算

3. **NLQueryEngine** (`layer4/`)
   - 意图识别
   - 实体提取
   - SQL生成

---

## ❓ 常见问题

### Q1: 升级后启动失败?

**A**: 检查依赖:
```bash
pip install pandas openpyxl pydantic
```

### Q2: 看不到新标签页?

**A**: 确认GUI已集成:
1. 检查 `dap_launcher.py` 是否包含新标签页导入
2. 重新运行 `integrate_new_tabs.py`

### Q3: 数据库升级失败?

**A**:
1. 检查 `data/` 目录是否存在
2. 检查数据库文件权限
3. 查看 `consolidation_upgrade.log`

### Q4: 合并报表显示"未找到数据"?

**A**:
1. 确认已导入财务数据
2. 检查数据期间是否匹配
3. 确认实体关联正确

### Q5: 自然语言查询返回空结果?

**A**:
1. 检查查询语句是否包含有效信息
2. 确认数据库有对应期间数据
3. 尝试使用快捷查询测试

### Q6: 如何标记内部交易?

**A**:
目前系统自动识别内部交易 (通过SQL模式匹配)。
未来版本将支持手工标记。

---

## 📊 使用示例

### 示例1: 创建三层集团架构

```
集团母公司 (ABC集团)
├─ 子公司A (80%持股)
│  └─ 孙公司A1 (60%持股, 有效持股48%)
└─ 子公司B (100%全资)
   └─ 孙公司B1 (51%持股, 有效持股51%)
```

**操作步骤**:
1. 创建项目 "ABC集团2024年度审计"
2. 添加母公司 "ABC集团"
3. 添加子公司A (持股80%)
4. 选中子公司A,添加孙公司A1 (持股60%)
5. 添加子公司B (持股100%)
6. 选中子公司B,添加孙公司B1 (持股51%)
7. 查看层级统计确认

### 示例2: 生成2024年12月合并资产负债表

**操作步骤**:
1. 切换到"合并报表"标签页
2. 母公司实体: 选择 "ABC集团"
3. 合并期间: 输入 "2024-12"
4. 报表类型: 选择 "资产负债表"
5. 最低持股比例: 20%
6. 合并方法: 勾选 "全额合并"
7. 点击 "🚀 生成合并报表"
8. 等待处理完成
9. 导出Excel报表

### 示例3: 自然语言查询应收账款

**查询**: "查询2024年12月应收账款余额"

**系统处理**:
- 意图: 查询余额
- 提取: 期间=2024-12, 科目=应收账款
- 生成SQL: 汇总借贷方金额,计算余额
- 展示结果

---

## 🔄 版本历史

### v2.0.0 - 合并报表功能发布 (2025-10-24)

**新增**:
- ✅ 多层级实体管理 (6+层)
- ✅ 合并报表生成引擎
- ✅ 自动内部交易识别
- ✅ 智能抵销分录生成
- ✅ 少数股东权益计算
- ✅ 自然语言查询引擎
- ✅ 7种查询意图识别
- ✅ 3个新GUI标签页

**数据库**:
- ✅ 5个新表
- ✅ 16个索引
- ✅ 完整外键约束

**文档**:
- ✅ 技术方案文档
- ✅ 使用指南
- ✅ API文档

---

## 📞 获取帮助

### 日志文件

- `dap.log` - 系统运行日志
- `consolidation_upgrade.log` - 升级日志

### 相关文档

- `改进方案_集团多层级合并报表.md` - 详细技术方案
- `项目文件说明.md` - 项目文件结构
- `README.md` - 项目总览

### 代码文件

- `layer2/group_hierarchy_manager.py` - 层级管理源码
- `layer2/consolidation_engine.py` - 合并引擎源码
- `layer4/nl_query_engine.py` - 查询引擎源码
- `gui_consolidation_tabs.py` - GUI实现源码

---

## 🎓 进阶主题

### 自定义抵销规则

修改 `consolidation_engine.py` 中的抵销方法:
- `_eliminate_goods_sale()` - 商品销售抵销
- `_eliminate_service_revenue()` - 服务收入抵销
- `_eliminate_internal_debt()` - 债权债务抵销
- `_eliminate_asset_transfer()` - 资产转让抵销

### 扩展自然语言查询

在 `nl_query_engine.py` 中:
1. 添加新意图到 `_intent_keywords`
2. 添加新科目模式到 `_account_patterns`
3. 实现对应的SQL生成方法

### 性能优化

对于大规模集团:
1. 使用数据库索引优化查询
2. 批量处理抵销分录
3. 缓存层级计算结果
4. 并行处理多个实体

---

## 🎉 开始使用!

现在您可以:

```bash
# 1. 升级系统
python upgrade_consolidation_features.py

# 2. 集成GUI
python integrate_new_tabs.py

# 3. 启动系统
start_gui.bat

# 4. 开始使用新功能!
```

**祝您使用愉快!** 🚀

---

**版本**: v2.0.0
**更新**: 2025-10-24
**状态**: ✅ 生产可用
