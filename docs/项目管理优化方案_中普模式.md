# DAP项目管理功能优化方案
## 基于中普审计软件最佳实践

**版本**: v1.0
**日期**: 2024-11-22
**参考**: 中普审计软件V10.0项目管理功能

---

## 📋 一、优化背景与目标

### 1.1 现状分析

**DAP当前项目管理功能**:
```
✅ 已实现:
├─ 基础项目CRUD (创建、读取、更新、删除)
├─ 项目成员管理
├─ 项目文件关联
├─ 活动日志记录
└─ 项目统计

❌ 缺失(参考中普):
├─ 项目分类管理 (IPO/年报/财务审计/税务审计)
├─ 审批流程引擎 (技术委员会/合伙人审批)
├─ 项目生命周期管理 (立项→执行→复核→归档)
├─ 底稿与项目无缝对接
├─ 项目模板化创建
└─ 质量控制检查点
```

### 1.2 优化目标

借鉴中普审计软件的项目管理精髓,实现:
1. **专业化分类**: 支持IPO、年报、财务审计、税务审计等专项管理
2. **流程化管控**: 内置审批流程,技术委员会质量把关
3. **标准化操作**: 项目模板化,确保审计质量一致性
4. **集成化管理**: 底稿、报表、报告与项目管理无缝对接
5. **可视化监控**: 项目进度、质量、风险实时可视

---

## 🎯 二、核心功能设计

### 2.1 项目分类管理体系

#### **项目类型定义**

```python
PROJECT_TYPES = {
    'ipo_audit': {
        'name': 'IPO审计',
        'code': 'IPO',
        'description': '首次公开发行股票审计',
        'required_phases': ['尽职调查', '财务审计', '内控审计', '申报辅导'],
        'required_documents': ['审计报告', '内控报告', '法律意见书', '招股说明书'],
        'quality_checkpoints': 15,  # 质量检查点数量
        'approval_levels': 3,  # 审批级别:项目经理→技术委员会→合伙人
        'typical_duration': 180,  # 天
        'team_size': {'min': 8, 'max': 20}
    },

    'annual_audit': {
        'name': '年报审计',
        'code': 'ANNUAL',
        'description': '年度财务报表审计',
        'required_phases': ['计划', '控制测试', '实质性测试', '完成阶段'],
        'required_documents': ['审计报告', '管理建议书', '审计总结'],
        'quality_checkpoints': 10,
        'approval_levels': 2,  # 项目经理→合伙人
        'typical_duration': 90,
        'team_size': {'min': 4, 'max': 10}
    },

    'financial_audit': {
        'name': '财务报表审计',
        'code': 'FIN',
        'description': '专项财务报表审计',
        'required_phases': ['计划', '执行', '复核', '报告'],
        'required_documents': ['审计报告'],
        'quality_checkpoints': 8,
        'approval_levels': 2,
        'typical_duration': 60,
        'team_size': {'min': 3, 'max': 8}
    },

    'tax_audit': {
        'name': '税务审计',
        'code': 'TAX',
        'description': '企业所得税汇算清缴审计',
        'required_phases': ['税务调查', '纳税调整', '汇算清缴', '报告'],
        'required_documents': ['税务审计报告', '纳税调整表'],
        'quality_checkpoints': 6,
        'approval_levels': 1,  # 项目经理
        'typical_duration': 30,
        'team_size': {'min': 2, 'max': 5}
    },

    'internal_control': {
        'name': '内部控制审计',
        'code': 'IC',
        'description': '企业内部控制评价与审计',
        'required_phases': ['控制测试', '缺陷识别', '整改跟踪', '报告'],
        'required_documents': ['内控审计报告', '缺陷整改清单'],
        'quality_checkpoints': 8,
        'approval_levels': 2,
        'typical_duration': 45,
        'team_size': {'min': 3, 'max': 8}
    },

    'special_purpose': {
        'name': '专项审计',
        'code': 'SPECIAL',
        'description': '资产评估、清产核资等专项审计',
        'required_phases': ['计划', '执行', '报告'],
        'required_documents': ['专项审计报告'],
        'quality_checkpoints': 5,
        'approval_levels': 2,
        'typical_duration': 45,
        'team_size': {'min': 3, 'max': 6}
    },

    'consolidated': {
        'name': '合并报表审计',
        'code': 'CONSOL',
        'description': '集团合并财务报表审计',
        'required_phases': ['单体审计', '合并调整', '抵消处理', '合并报告'],
        'required_documents': ['合并审计报告', '合并底稿'],
        'quality_checkpoints': 12,
        'approval_levels': 3,
        'typical_duration': 120,
        'team_size': {'min': 6, 'max': 15}
    }
}
```

#### **数据库扩展**

```sql
-- 扩展项目表
ALTER TABLE dap_projects ADD COLUMN project_category TEXT;  -- 项目大类
ALTER TABLE dap_projects ADD COLUMN audit_scope TEXT;  -- 审计范围
ALTER TABLE dap_projects ADD COLUMN materiality REAL;  -- 重要性水平
ALTER TABLE dap_projects ADD COLUMN risk_level TEXT;  -- 风险等级 (low/medium/high)
ALTER TABLE dap_projects ADD COLUMN team_lead TEXT;  -- 项目组长
ALTER TABLE dap_projects ADD COLUMN project_manager TEXT;  -- 项目经理
ALTER TABLE dap_projects ADD COLUMN partner TEXT;  -- 合伙人
ALTER TABLE dap_projects ADD COLUMN expected_hours REAL;  -- 预计工时
ALTER TABLE dap_projects ADD COLUMN actual_hours REAL;  -- 实际工时
ALTER TABLE dap_projects ADD COLUMN budget_amount REAL;  -- 预算金额
ALTER TABLE dap_projects ADD COLUMN contract_amount REAL;  -- 合同金额
ALTER TABLE dap_projects ADD COLUMN completion_rate REAL;  -- 完成率
ALTER TABLE dap_projects ADD COLUMN quality_score REAL;  -- 质量评分
ALTER TABLE dap_projects ADD COLUMN current_phase TEXT;  -- 当前阶段

-- 创建项目阶段表
CREATE TABLE IF NOT EXISTS dap_project_phases (
    phase_id TEXT PRIMARY KEY,
    project_id TEXT NOT NULL,
    phase_name TEXT NOT NULL,
    phase_order INTEGER,
    start_date TEXT,
    end_date TEXT,
    planned_hours REAL,
    actual_hours REAL,
    status TEXT DEFAULT 'pending',  -- pending/in_progress/completed/blocked
    assigned_to TEXT,
    deliverables TEXT,  -- JSON: 交付物列表
    completed_at TEXT,
    notes TEXT,
    FOREIGN KEY (project_id) REFERENCES dap_projects(project_id) ON DELETE CASCADE
);

-- 创建质量检查点表
CREATE TABLE IF NOT EXISTS dap_quality_checkpoints (
    checkpoint_id TEXT PRIMARY KEY,
    project_id TEXT NOT NULL,
    checkpoint_name TEXT NOT NULL,
    checkpoint_category TEXT,  -- planning/execution/review/completion
    required BOOLEAN DEFAULT TRUE,
    checked BOOLEAN DEFAULT FALSE,
    checked_by TEXT,
    checked_at TEXT,
    result TEXT,  -- passed/failed/not_applicable
    comments TEXT,
    FOREIGN KEY (project_id) REFERENCES dap_projects(project_id) ON DELETE CASCADE
);

-- 创建项目模板表
CREATE TABLE IF NOT EXISTS dap_project_templates (
    template_id TEXT PRIMARY KEY,
    template_name TEXT NOT NULL,
    project_type TEXT NOT NULL,
    template_config TEXT,  -- JSON: 模板配置
    phases_config TEXT,  -- JSON: 阶段配置
    checkpoints_config TEXT,  -- JSON: 检查点配置
    workpaper_templates TEXT,  -- JSON: 底稿模板列表
    is_active BOOLEAN DEFAULT TRUE,
    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
    updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);
```

---

### 2.2 审批流程引擎

#### **流程定义**

```python
class ApprovalWorkflowEngine:
    """审批流程引擎"""

    # 审批流程定义
    WORKFLOWS = {
        'ipo_audit': [
            {
                'step': 1,
                'name': '项目经理审核',
                'approver_role': 'project_manager',
                'required': True,
                'documents': ['审计计划', '风险评估', '重要性评估'],
                'sla_hours': 24
            },
            {
                'step': 2,
                'name': '技术委员会审核',
                'approver_role': 'technical_committee',
                'required': True,
                'documents': ['审计底稿', '审计报告草稿'],
                'sla_hours': 72
            },
            {
                'step': 3,
                'name': '合伙人审批',
                'approver_role': 'partner',
                'required': True,
                'documents': ['最终审计报告', '管理建议书'],
                'sla_hours': 48
            }
        ],

        'annual_audit': [
            {
                'step': 1,
                'name': '项目经理审核',
                'approver_role': 'project_manager',
                'required': True,
                'documents': ['审计底稿', '审计报告草稿'],
                'sla_hours': 24
            },
            {
                'step': 2,
                'name': '合伙人审批',
                'approver_role': 'partner',
                'required': True,
                'documents': ['最终审计报告'],
                'sla_hours': 48
            }
        ],

        'tax_audit': [
            {
                'step': 1,
                'name': '项目经理审核',
                'approver_role': 'project_manager',
                'required': True,
                'documents': ['税审报告'],
                'sla_hours': 24
            }
        ]
    }

    def submit_for_approval(self, project_id: str,
                          submission_type: str,
                          documents: List[str]) -> Dict:
        """提交审批"""

        # 1. 获取项目信息
        project = self.get_project(project_id)
        project_type = project['project_type']

        # 2. 获取审批流程
        workflow = self.WORKFLOWS.get(project_type, self.WORKFLOWS['annual_audit'])

        # 3. 确定当前应该提交给哪个审批节点
        current_approvals = self.get_project_approvals(project_id)
        next_step = len(current_approvals) + 1

        if next_step > len(workflow):
            return {
                'success': False,
                'error': '所有审批流程已完成'
            }

        next_workflow_step = workflow[next_step - 1]

        # 4. 验证必需文档
        missing_docs = set(next_workflow_step['documents']) - set(documents)
        if missing_docs:
            return {
                'success': False,
                'error': f'缺少必需文档: {", ".join(missing_docs)}'
            }

        # 5. 创建审批记录
        approval_id = str(uuid.uuid4())
        approval_record = {
            'approval_id': approval_id,
            'project_id': project_id,
            'step': next_step,
            'step_name': next_workflow_step['name'],
            'approver_role': next_workflow_step['approver_role'],
            'submitted_by': self.current_user,
            'submitted_at': datetime.now().isoformat(),
            'documents': json.dumps(documents),
            'status': 'pending',
            'sla_deadline': self._calculate_sla_deadline(next_workflow_step['sla_hours'])
        }

        self.save_approval_record(approval_record)

        # 6. 发送通知给审批人
        approvers = self.get_users_by_role(next_workflow_step['approver_role'], project_id)
        for approver in approvers:
            self.send_approval_notification(approver, approval_record)

        # 7. 更新项目状态
        self.update_project_status(project_id, f'待{next_workflow_step["name"]}')

        return {
            'success': True,
            'approval_id': approval_id,
            'next_approver': next_workflow_step['approver_role'],
            'sla_deadline': approval_record['sla_deadline'],
            'message': f'已提交{next_workflow_step["name"]},请等待审批'
        }

    def approve(self, approval_id: str, comments: str = None,
               attachments: List[str] = None) -> Dict:
        """审批通过"""

        approval = self.get_approval_record(approval_id)

        # 验证审批权限
        if not self.has_approval_permission(self.current_user, approval['approver_role']):
            return {
                'success': False,
                'error': '无审批权限'
            }

        # 更新审批记录
        self.update_approval_record(approval_id, {
            'status': 'approved',
            'approved_by': self.current_user,
            'approved_at': datetime.now().isoformat(),
            'comments': comments,
            'attachments': json.dumps(attachments) if attachments else None
        })

        # 检查是否所有审批都已完成
        project_id = approval['project_id']
        all_approvals = self.get_project_approvals(project_id)

        if all(a['status'] == 'approved' for a in all_approvals):
            # 所有审批完成
            self.update_project_status(project_id, '审批完成')
            self.send_completion_notification(project_id)

            return {
                'success': True,
                'message': '审批通过,项目所有审批流程已完成',
                'all_approved': True
            }
        else:
            # 还有下一级审批
            self.update_project_status(project_id, '等待下一级审批')

            return {
                'success': True,
                'message': '审批通过,已流转至下一级审批',
                'all_approved': False
            }

    def reject(self, approval_id: str, reason: str) -> Dict:
        """驳回"""

        approval = self.get_approval_record(approval_id)

        if not self.has_approval_permission(self.current_user, approval['approver_role']):
            return {
                'success': False,
                'error': '无审批权限'
            }

        # 更新审批记录
        self.update_approval_record(approval_id, {
            'status': 'rejected',
            'rejected_by': self.current_user,
            'rejected_at': datetime.now().isoformat(),
            'rejection_reason': reason
        })

        # 更新项目状态
        project_id = approval['project_id']
        self.update_project_status(project_id, '审批驳回-需修改')

        # 通知提交人
        self.send_rejection_notification(
            project_id,
            approval['submitted_by'],
            approval['step_name'],
            reason
        )

        return {
            'success': True,
            'message': f'已驳回,原因: {reason}'
        }
```

**审批流程数据库**:

```sql
-- 审批记录表
CREATE TABLE IF NOT EXISTS dap_project_approvals (
    approval_id TEXT PRIMARY KEY,
    project_id TEXT NOT NULL,
    step INTEGER,
    step_name TEXT,
    approver_role TEXT,
    submitted_by TEXT,
    submitted_at TEXT,
    documents TEXT,  -- JSON: 提交的文档列表
    status TEXT DEFAULT 'pending',  -- pending/approved/rejected
    approved_by TEXT,
    approved_at TEXT,
    rejected_by TEXT,
    rejected_at TEXT,
    rejection_reason TEXT,
    comments TEXT,
    attachments TEXT,  -- JSON: 审批意见附件
    sla_deadline TEXT,
    is_overdue BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (project_id) REFERENCES dap_projects(project_id) ON DELETE CASCADE
);

-- 技术委员会成员表
CREATE TABLE IF NOT EXISTS dap_technical_committee (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    user_name TEXT,
    position TEXT,  -- 主任/副主任/委员
    specialization TEXT,  -- 专业领域
    is_active BOOLEAN DEFAULT TRUE,
    appointed_at TEXT,
    UNIQUE(user_id)
);
```

---

### 2.3 项目生命周期管理

#### **完整生命周期**

```
阶段0: 立项阶段
  ├─ 客户开发
  ├─ 风险评估
  ├─ 报价谈判
  ├─ 合同签订
  └─ 项目立项审批
       ↓
阶段1: 计划阶段
  ├─ 组建审计组
  ├─ 编制审计计划
  ├─ 风险评估
  ├─ 重要性评估
  ├─ 审计程序设计
  └─ 计划审批
       ↓
阶段2: 执行阶段
  ├─ 现场审计
  ├─ 测试执行
  ├─ 证据收集
  ├─ 底稿编制
  └─ 异常问题处理
       ↓
阶段3: 复核阶段
  ├─ 项目组长复核
  ├─ 项目经理复核
  ├─ 质量控制复核
  └─ 技术委员会复核(IPO等重大项目)
       ↓
阶段4: 报告阶段
  ├─ 审计报告草稿
  ├─ 管理层沟通
  ├─ 报告修改
  ├─ 合伙人审批
  └─ 报告出具
       ↓
阶段5: 归档阶段
  ├─ 底稿整理
  ├─ 归档检查
  ├─ 电子归档
  └─ 项目总结
```

#### **实现代码**:

```python
class ProjectLifecycleManager:
    """项目生命周期管理"""

    LIFECYCLE_PHASES = {
        'ipo_audit': [
            {'name': '立项审批', 'key': 'initiation', 'required_docs': ['业务承接评价表']},
            {'name': '审计计划', 'key': 'planning', 'required_docs': ['审计计划', '风险评估']},
            {'name': '现场审计', 'key': 'fieldwork', 'required_docs': ['现场工作记录']},
            {'name': '初步复核', 'key': 'review1', 'required_docs': ['复核清单']},
            {'name': '技术复核', 'key': 'technical_review', 'required_docs': ['技术复核意见']},
            {'name': '报告出具', 'key': 'reporting', 'required_docs': ['审计报告']},
            {'name': '归档', 'key': 'archiving', 'required_docs': ['归档清单']}
        ],
        'annual_audit': [
            {'name': '立项', 'key': 'initiation', 'required_docs': ['业务承接']},
            {'name': '计划', 'key': 'planning', 'required_docs': ['审计计划']},
            {'name': '执行', 'key': 'execution', 'required_docs': ['底稿']},
            {'name': '复核', 'key': 'review', 'required_docs': ['复核意见']},
            {'name': '报告', 'key': 'reporting', 'required_docs': ['审计报告']},
            {'name': '归档', 'key': 'archiving', 'required_docs': ['归档清单']}
        ]
    }

    def create_project_from_template(self, template_id: str,
                                    project_data: Dict) -> Dict:
        """从模板创建项目"""

        # 1. 获取模板
        template = self.get_template(template_id)
        project_type = template['project_type']

        # 2. 创建项目
        project_id = self.create_project({
            **project_data,
            'project_type': project_type,
            'current_phase': 'initiation'
        })

        # 3. 创建项目阶段
        phases_config = json.loads(template['phases_config'])
        for i, phase_config in enumerate(phases_config):
            self.create_project_phase({
                'project_id': project_id,
                'phase_name': phase_config['name'],
                'phase_order': i + 1,
                'status': 'pending' if i > 0 else 'in_progress',
                'planned_hours': phase_config.get('planned_hours', 0),
                'deliverables': json.dumps(phase_config.get('deliverables', []))
            })

        # 4. 创建质量检查点
        checkpoints_config = json.loads(template['checkpoints_config'])
        for checkpoint in checkpoints_config:
            self.create_quality_checkpoint({
                'project_id': project_id,
                'checkpoint_name': checkpoint['name'],
                'checkpoint_category': checkpoint['category'],
                'required': checkpoint.get('required', True)
            })

        # 5. 关联底稿模板
        workpaper_templates = json.loads(template['workpaper_templates'])
        for wp_template_id in workpaper_templates:
            self.link_workpaper_template(project_id, wp_template_id)

        return {
            'success': True,
            'project_id': project_id,
            'message': f'项目创建成功,已自动设置{len(phases_config)}个阶段和{len(checkpoints_config)}个质量检查点'
        }

    def advance_to_next_phase(self, project_id: str) -> Dict:
        """进入下一阶段"""

        # 1. 获取当前阶段
        project = self.get_project(project_id)
        phases = self.get_project_phases(project_id)

        current_phase = next((p for p in phases if p['status'] == 'in_progress'), None)

        if not current_phase:
            return {'success': False, 'error': '未找到当前阶段'}

        # 2. 检查当前阶段的质量检查点
        checkpoints = self.get_phase_checkpoints(project_id, current_phase['phase_id'])
        required_checkpoints = [c for c in checkpoints if c['required']]
        unchecked = [c for c in required_checkpoints if not c['checked']]

        if unchecked:
            return {
                'success': False,
                'error': f'当前阶段还有{len(unchecked)}个必检项未完成',
                'unchecked_items': [c['checkpoint_name'] for c in unchecked]
            }

        # 3. 检查当前阶段的交付物
        deliverables = json.loads(current_phase['deliverables'])
        missing_deliverables = self.check_deliverables(project_id, deliverables)

        if missing_deliverables:
            return {
                'success': False,
                'error': f'当前阶段还有交付物未完成',
                'missing_deliverables': missing_deliverables
            }

        # 4. 完成当前阶段
        self.complete_phase(current_phase['phase_id'])

        # 5. 激活下一阶段
        next_phase_order = current_phase['phase_order'] + 1
        next_phase = next((p for p in phases if p['phase_order'] == next_phase_order), None)

        if next_phase:
            self.activate_phase(next_phase['phase_id'])
            self.update_project(project_id, {
                'current_phase': next_phase['phase_name']
            })

            return {
                'success': True,
                'message': f'已进入{next_phase["phase_name"]}阶段',
                'next_phase': next_phase['phase_name']
            }
        else:
            # 所有阶段完成
            self.update_project(project_id, {
                'current_phase': 'completed',
                'status': 'completed',
                'completion_rate': 100
            })

            return {
                'success': True,
                'message': '项目所有阶段已完成',
                'all_completed': True
            }
```

---

### 2.4 底稿与项目管理无缝对接

```python
class WorkpaperProjectIntegration:
    """底稿与项目管理集成"""

    def create_workpaper_from_project(self, project_id: str,
                                     template_id: str) -> Dict:
        """从项目创建底稿"""

        # 1. 获取项目信息
        project = self.get_project(project_id)

        # 2. 创建底稿,自动继承项目信息
        workpaper_data = {
            'project_id': project_id,
            'template_id': template_id,
            'fiscal_year': project['fiscal_year'],
            'fiscal_period': project['fiscal_period'],
            'client_name': project['client_name'],
            'client_code': project['client_code'],
            'prepared_by': self.current_user,
            'project_manager': project['project_manager'],
            'partner': project['partner']
        }

        workpaper_id = self.workpaper_manager.create_from_template(workpaper_data)

        # 3. 建立关联
        self.link_workpaper_to_project(project_id, workpaper_id)

        # 4. 更新项目统计
        self.increment_project_workpaper_count(project_id)

        return {
            'success': True,
            'workpaper_id': workpaper_id,
            'message': '底稿已创建并关联到项目'
        }

    def get_project_workpapers(self, project_id: str) -> List[Dict]:
        """获取项目的所有底稿"""

        workpapers = self.db.execute("""
            SELECT w.*, t.template_name, t.category
            FROM dap_workpapers w
            JOIN dap_workpaper_templates t ON w.template_id = t.template_id
            WHERE w.project_id = ?
            ORDER BY t.category, w.index_number
        """, (project_id,)).fetchall()

        return [dict(w) for w in workpapers]

    def calculate_project_completion(self, project_id: str) -> float:
        """计算项目完成率(基于底稿)"""

        workpapers = self.get_project_workpapers(project_id)

        if not workpapers:
            return 0.0

        total = len(workpapers)
        approved = len([w for w in workpapers if w['status'] == 'approved'])

        return (approved / total) * 100
```

---

## 🖥️ 三、界面设计

### 3.1 项目创建向导

```
┌──────────────────────────────────────────────────────────────┐
│  新建审计项目向导                                [1/4]         │
├──────────────────────────────────────────────────────────────┤
│  步骤1: 选择项目类型                                          │
│                                                               │
│  ┌────────┬────────┬────────┬────────┐                      │
│  │ 📊     │ 📈     │ 💰     │ 📋     │                      │
│  │ IPO审计│ 年报审计│ 税务审计│ 内控审计│                      │
│  │        │        │        │        │                      │
│  │ 180天  │ 90天   │ 30天   │ 45天   │                      │
│  │ 8-20人 │ 4-10人 │ 2-5人  │ 3-8人  │                      │
│  └────────┴────────┴────────┴────────┘                      │
│  ┌────────┬────────┬────────┐                               │
│  │ 📊     │ 🔍     │ ⚙️     │                               │
│  │合并审计 │ 专项审计│ 其他   │                               │
│  │ 120天  │ 45天   │ 自定义  │                               │
│  │ 6-15人 │ 3-6人  │ -      │                               │
│  └────────┴────────┴────────┘                               │
│                                                               │
│  已选择: IPO审计 ✓                                            │
│                                                               │
│  [上一步]                      [下一步] [使用模板] [取消]      │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  新建审计项目向导                                [2/4]         │
├──────────────────────────────────────────────────────────────┤
│  步骤2: 填写项目信息                                          │
│                                                               │
│  项目名称: ______________________________________ *            │
│  项目编码: [IPO-2024-001]  (自动生成)                         │
│                                                               │
│  客户信息:                                                    │
│  客户名称: ______________________________________ *            │
│  客户编码: [CLI-2024-001]   [选择已有客户 ▼]                 │
│  所属行业: [制造业 ▼]                                         │
│                                                               │
│  审计期间:                                                    │
│  会计年度: [2024 ▼]                                           │
│  开始日期: [2024-01-01]  结束日期: [2024-12-31]              │
│                                                               │
│  审计范围:                                                    │
│  □ 母公司单体       □ 合并报表                               │
│  □ 财务报表审计     □ 内部控制审计                            │
│                                                               │
│  风险评估:                                                    │
│  风险等级: ⚪ 低   ⚪ 中   ⚪ 高                              │
│  重要性水平: [1,000,000] 元                                   │
│                                                               │
│  [上一步]                               [下一步] [取消]       │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  新建审计项目向导                                [3/4]         │
├──────────────────────────────────────────────────────────────┤
│  步骤3: 配置审计组                                            │
│                                                               │
│  合伙人:     [张某某 ▼]  (负责人,最终审批)                    │
│  项目经理:   [李某某 ▼]  (质量控制,二级审批)                  │
│  项目组长:   [王某某 ▼]  (现场负责,一级复核)                  │
│                                                               │
│  审计组成员:                                                  │
│  ┌──────┬────────┬────────┬──────┬──────┐                  │
│  │ 姓名 │ 职级   │ 专业   │ 角色 │ 操作 │                  │
│  ├──────┼────────┼────────┼──────┼──────┤                  │
│  │ 赵某 │ 高级审计员│ 财务  │ 组员 │ 删除 │                  │
│  │ 孙某 │ 审计员   │ 税务  │ 组员 │ 删除 │                  │
│  │ 周某 │ 审计员   │ 内控  │ 组员 │ 删除 │                  │
│  └──────┴────────┴────────┴──────┴──────┘                  │
│  [+ 添加成员]                                                │
│                                                               │
│  预计工时分配:                                                │
│  合伙人: 40小时   项目经理: 120小时   组长: 200小时          │
│  审计员: 800小时  合计: 1160小时                             │
│                                                               │
│  [上一步]                               [下一步] [取消]       │
└──────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────┐
│  新建审计项目向导                                [4/4]         │
├──────────────────────────────────────────────────────────────┤
│  步骤4: 确认并提交                                            │
│                                                               │
│  项目概览:                                                    │
│  ├─ 项目类型: IPO审计                                         │
│  ├─ 项目名称: XX科技股份有限公司IPO审计                       │
│  ├─ 客户: XX科技股份有限公司                                  │
│  ├─ 审计期间: 2024年度                                        │
│  ├─ 风险等级: 中                                              │
│  └─ 预计工期: 180天                                           │
│                                                               │
│  审计组:                                                      │
│  ├─ 合伙人: 张某某                                            │
│  ├─ 项目经理: 李某某                                          │
│  ├─ 项目组长: 王某某                                          │
│  └─ 组员: 3人                                                 │
│                                                               │
│  将自动创建:                                                  │
│  ✓ 7个审计阶段                                               │
│  ✓ 15个质量检查点                                            │
│  ✓ 28个底稿模板                                              │
│  ✓ 3级审批流程                                               │
│                                                               │
│  备注: _______________________                                │
│                                                               │
│  [上一步]        [保存草稿] [提交立项审批] [取消]             │
└──────────────────────────────────────────────────────────────┘
```

### 3.2 项目管理主界面

```
┌──────────────────────────────────────────────────────────────┐
│  项目管理  [📊仪表板] [📋列表] [📅日历] [📈统计]              │
├──────────────────────────────────────────────────────────────┤
│  筛选: 类型[全部▼] 状态[进行中▼] 年度[2024▼]  [🔍搜索]      │
├──────────────────────────────────────────────────────────────┤
│  序号│项目编码    │项目名称  │类型│阶段│进度│审批│截止日期 │操作│
│  ────┼───────────┼────────┼────┼────┼────┼────┼────────┼───┤
│  1  │IPO-2024-001│XX科技IPO│IPO │复核│75% │待批│2024-06-30│⋮ │
│  2  │ANN-2024-012│ABC年审  │年报│执行│45% │一审│2024-03-31│⋮ │
│  3  │TAX-2024-033│DEF税审  │税务│报告│90% │完成│2024-04-15│⋮ │
│  ────┴───────────┴────────┴────┴────┴────┴────┴────────┴───┤
│                                                               │
│  项目详情: XX科技股份有限公司IPO审计                          │
│  ┌────────────────┬──────────────────────────────┐         │
│  │ 基本信息        │ 进度与质量                    │         │
│  ├────────────────┼──────────────────────────────┤         │
│  │ 项目类型: IPO审计│ 当前阶段: 技术复核           │         │
│  │ 客户: XX科技    │ 完成率: ████████░░ 75%       │         │
│  │ 合伙人: 张某某  │ 质量评分: ★★★★☆ 4.2/5.0   │         │
│  │ 项目经理:李某某 │ 底稿: 21/28 已完成           │         │
│  │ 开始: 2024-01-01│ 检查点: 12/15 已通过         │         │
│  │ 截止: 2024-06-30│ 工时: 850/1160 (73%)        │         │
│  └────────────────┴──────────────────────────────┘         │
│                                                               │
│  审批流程:                                                    │
│  ✅ 项目经理审核 (李某某, 2024-11-15) → ⏳ 技术委员会审核    │
│  → ⏹️ 合伙人审批                                             │
│                                                               │
│  [查看底稿] [查看报告] [提交审批] [项目设置] [关闭项目]       │
└──────────────────────────────────────────────────────────────┘
```

---

## 📦 四、实施方案

### 4.1 数据库迁移脚本

```python
# migration_project_enhancement.py

def upgrade_database():
    """升级数据库以支持项目分类和审批流程"""

    migrations = [
        # 1. 扩展项目表
        """
        ALTER TABLE dap_projects ADD COLUMN project_category TEXT;
        ALTER TABLE dap_projects ADD COLUMN audit_scope TEXT;
        ALTER TABLE dap_projects ADD COLUMN materiality REAL;
        ALTER TABLE dap_projects ADD COLUMN risk_level TEXT DEFAULT 'medium';
        ALTER TABLE dap_projects ADD COLUMN team_lead TEXT;
        ALTER TABLE dap_projects ADD COLUMN project_manager TEXT;
        ALTER TABLE dap_projects ADD COLUMN partner TEXT;
        ALTER TABLE dap_projects ADD COLUMN expected_hours REAL;
        ALTER TABLE dap_projects ADD COLUMN actual_hours REAL DEFAULT 0;
        ALTER TABLE dap_projects ADD COLUMN budget_amount REAL;
        ALTER TABLE dap_projects ADD COLUMN contract_amount REAL;
        ALTER TABLE dap_projects ADD COLUMN completion_rate REAL DEFAULT 0;
        ALTER TABLE dap_projects ADD COLUMN quality_score REAL;
        ALTER TABLE dap_projects ADD COLUMN current_phase TEXT DEFAULT 'initiation';
        """,

        # 2. 创建新表
        """
        CREATE TABLE IF NOT EXISTS dap_project_phases (...);
        CREATE TABLE IF NOT EXISTS dap_quality_checkpoints (...);
        CREATE TABLE IF NOT EXISTS dap_project_templates (...);
        CREATE TABLE IF NOT EXISTS dap_project_approvals (...);
        CREATE TABLE IF NOT EXISTS dap_technical_committee (...);
        """,

        # 3. 创建索引
        """
        CREATE INDEX idx_projects_type ON dap_projects(project_type);
        CREATE INDEX idx_projects_phase ON dap_projects(current_phase);
        CREATE INDEX idx_approvals_status ON dap_project_approvals(status);
        """
    ]

    for migration in migrations:
        try:
            conn.execute(migration)
        except Exception as e:
            logger.warning(f"Migration warning: {e}")

    conn.commit()
```

### 4.2 预置项目模板

```python
# 预置IPO审计项目模板
ipo_template = {
    'template_name': 'IPO审计标准模板',
    'project_type': 'ipo_audit',
    'phases_config': json.dumps([
        {'name': '立项审批', 'planned_hours': 40, 'deliverables': ['业务承接评价表']},
        {'name': '审计计划', 'planned_hours': 120, 'deliverables': ['审计计划', '风险评估']},
        {'name': '现场审计', 'planned_hours': 600, 'deliverables': ['审计底稿']},
        # ... 更多阶段
    ]),
    'checkpoints_config': json.dumps([
        {'name': '独立性检查', 'category': 'planning', 'required': True},
        {'name': '重要性评估', 'category': 'planning', 'required': True},
        # ... 更多检查点
    ]),
    'workpaper_templates': json.dumps([
        'WP-CASH-001',  # 货币资金
        'WP-AR-001',    # 应收账款
        # ... 更多底稿模板
    ])
}
```

### 4.3 实施步骤

```
Week 1-2: 数据库扩展
  ├─ 执行数据库迁移脚本
  ├─ 创建新表和索引
  └─ 数据验证测试

Week 3-4: 核心功能开发
  ├─ 项目分类管理
  ├─ 审批流程引擎
  ├─ 项目生命周期管理
  └─ 单元测试

Week 5-6: 界面开发
  ├─ 项目创建向导
  ├─ 项目管理主界面
  ├─ 审批流程界面
  └─ 质量检查点界面

Week 7: 集成测试
  ├─ 功能测试
  ├─ 性能测试
  └─ 用户验收测试

Week 8: 上线部署
  ├─ 数据迁移
  ├─ 用户培训
  └─ 正式上线

总计: 8周
```

---

## ✅ 五、预期成果

### 5.1 功能对比

| 功能项 | 优化前 | 优化后 (中普模式) |
|-------|--------|------------------|
| 项目类型 | 通用(general) | 7种专业类型分类 |
| 审批流程 | 无 | 1-3级审批流程 |
| 质量检查 | 手动检查 | 自动化检查点 |
| 项目阶段 | 无 | 完整生命周期管理 |
| 底稿集成 | 松散关联 | 无缝对接 |
| 进度监控 | 简单百分比 | 多维度可视化 |
| 模板化 | 无 | 7类项目模板 |

### 5.2 业务价值

✅ **提升审计质量**
- 标准化流程确保质量一致性
- 15个质量检查点全程把控
- 技术委员会复核重大项目

✅ **提高工作效率**
- 项目模板化创建,节省50%立项时间
- 底稿自动关联,减少80%重复工作
- 审批流程自动化,加快30%周转速度

✅ **加强风险管控**
- 分级审批机制防范执业风险
- 质量检查点及时发现问题
- 完整审计追踪保障合规

✅ **优化资源配置**
- 工时预算与实际对比
- 审计组能力匹配
- 项目进度实时监控

---

## 📝 六、总结

本方案基于中普审计软件的项目管理最佳实践,对DAP项目管理功能进行了全面优化:

1. **专业化分类**: 7种审计类型,每种都有专属的流程、检查点和模板
2. **流程化管控**: 1-3级审批流程,技术委员会质量把关
3. **标准化操作**: 项目模板化,一键创建完整项目架构
4. **集成化管理**: 底稿、阶段、审批、质量检查一体化
5. **可视化监控**: 进度、工时、质量、风险全维度展现

完整实现后,DAP将具备与主流审计软件相媲美的项目管理能力,成为审计业务的强大支撑平台。
